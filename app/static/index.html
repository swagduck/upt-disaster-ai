<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT COMMANDER V28.1 (FULL CONTROL)</title>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš¡</text></svg>"
    />

    <script src="//unpkg.com/three@0.124.0/build/three.min.js"></script>
    <script src="//unpkg.com/globe.gl@2.26.4/dist/globe.gl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;600;700&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        /* COLOR PALETTE */
        --c-bg: #000000;
        --c-grid: #0a1510;
        --c-primary: #00ff66; /* Hacker Green */
        --c-sec: #00f3ff; /* Cyan */
        --c-warn: #ffd700; /* Gold */
        --c-danger: #ff003c; /* Red */
        --c-toxic: #ccff00; /* Toxic Yellow */

        --f-tech: "Orbitron", sans-serif;
        --f-data: "Rajdhani", sans-serif;
        --f-code: "VT323", monospace;
      }

      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        background: var(--c-bg);
        color: var(--c-primary);
        font-family: var(--f-data);
        overflow: hidden;
        height: 100vh;
      }

      .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 100;
        background: linear-gradient(
            rgba(18, 16, 16, 0) 50%,
            rgba(0, 0, 0, 0.25) 50%
          ),
          linear-gradient(
            90deg,
            rgba(255, 0, 0, 0.06),
            rgba(0, 255, 0, 0.02),
            rgba(0, 0, 255, 0.06)
          );
        background-size: 100% 2px, 3px 100%;
        opacity: 0.6;
      }

      #globe-viz {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      /* --- UI COMPONENTS --- */

      #top-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 80px;
        z-index: 10;
        display: flex;
        justify-content: center;
        padding-top: 10px;
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.9), transparent);
        pointer-events: none;
      }
      #defcon-panel {
        background: rgba(0, 20, 10, 0.8);
        border: 2px solid var(--c-primary);
        padding: 5px 40px;
        clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%);
        box-shadow: 0 0 20px rgba(0, 255, 100, 0.2);
        text-align: center;
        pointer-events: auto;
      }
      #defcon-val {
        font-family: var(--f-tech);
        font-size: 2.5rem;
        font-weight: 900;
        color: var(--c-primary);
        text-shadow: 0 0 15px currentColor;
        letter-spacing: 5px;
      }

      #ticker-line {
        position: absolute;
        top: 85px;
        width: 100%;
        background: rgba(0, 0, 0, 0.8);
        border-top: 1px solid var(--c-sec);
        border-bottom: 1px solid var(--c-sec);
        font-family: var(--f-code);
        font-size: 1.2rem;
        color: var(--c-warn);
        white-space: nowrap;
        overflow: hidden;
        padding: 2px 0;
        z-index: 5;
      }
      #ticker-content {
        display: inline-block;
        padding-left: 100%;
        animation: scroll 40s linear infinite;
      }
      @keyframes scroll {
        100% {
          transform: translateX(-100%);
        }
      }

      /* TERMINAL (RESTORED INPUT) */
      #terminal {
        position: absolute;
        top: 130px;
        left: 20px;
        width: 350px;
        height: 35vh;
        background: rgba(5, 10, 5, 0.9);
        border: 1px solid #333;
        border-left: 4px solid var(--c-primary);
        font-family: var(--f-code);
        font-size: 1.1rem;
        color: var(--c-primary);
        display: flex;
        flex-direction: column;
        z-index: 10;
        box-shadow: 0 0 15px rgba(0, 255, 100, 0.1);
      }
      #term-body {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .ln {
        margin-bottom: 2px;
      }
      .sys {
        color: #888;
      }
      .err {
        color: var(--c-danger);
      }
      .ai {
        color: #bd00ff;
      }
      .cmd {
        color: #fff;
        font-weight: bold;
      }

      #term-input-box {
        display: flex;
        align-items: center;
        border-top: 1px solid #333;
        padding: 5px;
        background: rgba(0, 255, 100, 0.05);
      }
      #mic-btn {
        background: transparent;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        margin-right: 5px;
        filter: grayscale(100%);
        transition: 0.3s;
      }
      #mic-btn:hover {
        filter: grayscale(0%);
        text-shadow: 0 0 10px var(--c-danger);
      }
      #mic-btn.listening {
        filter: grayscale(0%);
        animation: blinkRed 1s infinite;
      }

      #term-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: var(--f-code);
        font-size: 1.1rem;
        flex: 1;
        outline: none;
        margin-left: 5px;
      }

      @keyframes blinkRed {
        0% {
          opacity: 1;
          color: var(--c-danger);
        }
        50% {
          opacity: 0.5;
          color: #fff;
        }
        100% {
          opacity: 1;
          color: var(--c-danger);
        }
      }

      /* INSPECTOR */
      #inspector {
        position: absolute;
        top: 130px;
        right: -400px;
        width: 300px;
        background: rgba(5, 10, 15, 0.95);
        border: 2px solid var(--c-sec);
        padding: 20px;
        z-index: 10;
        transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: -10px 10px 20px rgba(0, 0, 0, 0.5);
      }
      #inspector.open {
        right: 20px;
      }
      .insp-row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #333;
        padding: 5px 0;
        margin-bottom: 5px;
      }
      .insp-lbl {
        color: #888;
        font-size: 0.8rem;
        letter-spacing: 1px;
      }
      .insp-val {
        font-weight: bold;
        color: #fff;
      }

      /* BOTTOM HUD */
      .hud-grid {
        position: absolute;
        bottom: 20px;
        left: 20px;
        right: 20px;
        height: 25vh;
        min-height: 200px;
        display: grid;
        grid-template-columns: 200px 1fr 1fr 320px;
        gap: 10px;
        z-index: 10;
        pointer-events: none;
      }
      .panel {
        background: rgba(5, 10, 10, 0.85);
        border: 1px solid var(--c-primary);
        padding: 10px;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        position: relative;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      }
      .panel h3 {
        margin: 0 0 10px 0;
        font-family: var(--f-tech);
        font-size: 0.8rem;
        color: var(--c-primary);
        letter-spacing: 2px;
        border-bottom: 1px solid #333;
        padding-bottom: 5px;
      }

      .btn-matrix {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        height: 100%;
      }
      .hud-btn {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid #444;
        color: #666;
        font-family: var(--f-tech);
        font-size: 0.7rem;
        cursor: pointer;
        transition: 0.2s;
        text-transform: uppercase;
        font-weight: bold;
      }
      .hud-btn:hover {
        color: #fff;
        border-color: #fff;
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
      }
      .hud-btn.active.quake {
        background: rgba(0, 243, 255, 0.2);
        border-color: var(--c-sec);
        color: var(--c-sec);
      }
      .hud-btn.active.fire {
        background: rgba(255, 102, 0, 0.2);
        border-color: #ff6600;
        color: #ff6600;
      }
      .hud-btn.active.storm {
        background: rgba(189, 0, 255, 0.2);
        border-color: #bd00ff;
        color: #bd00ff;
      }
      .hud-btn.active.nuke {
        background: rgba(204, 255, 0, 0.2);
        border-color: var(--c-toxic);
        color: var(--c-toxic);
      }
      .hud-btn.active.ai {
        background: #fff;
        border-color: #fff;
        color: #000;
        box-shadow: 0 0 15px #fff;
      }

      #start-screen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 9999;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        backdrop-filter: blur(10px);
      }
      .big-btn {
        padding: 20px 60px;
        font-family: var(--f-tech);
        font-size: 1.5rem;
        background: transparent;
        border: 2px solid var(--c-primary);
        color: var(--c-primary);
        cursor: pointer;
        text-transform: uppercase;
        letter-spacing: 5px;
        transition: 0.3s;
        box-shadow: 0 0 30px rgba(0, 255, 100, 0.2);
      }
      .big-btn:hover {
        background: var(--c-primary);
        color: #000;
        box-shadow: 0 0 60px var(--c-primary);
      }
    </style>
  </head>
  <body>
    <div class="scanlines"></div>

    <div id="start-screen">
      <h1
        style="
          font-family: var(--f-tech);
          font-size: 4rem;
          color: #fff;
          text-shadow: 0 0 30px var(--c-primary);
          margin-bottom: 10px;
        "
      >
        UPT SENTINEL
      </h1>
      <p style="font-family: var(--f-code); color: #888; margin-bottom: 40px">
        V28.1 // FULL CONTROL KERNEL
      </p>
      <button class="big-btn" onclick="bootSystem()">INITIALIZE SYSTEM</button>
    </div>

    <div id="globe-viz"></div>

    <div id="top-bar">
      <div id="defcon-panel">
        <div style="font-size: 0.7rem; color: #666; letter-spacing: 3px">
          GLOBAL THREAT LEVEL
        </div>
        <div id="defcon-val">DEFCON 5</div>
      </div>
    </div>

    <div id="ticker-line">
      <div id="ticker-content">
        SYSTEM OFFLINE... WAITING FOR INITIALIZATION...
      </div>
    </div>

    <div id="terminal">
      <div
        style="
          background: var(--c-primary);
          color: #000;
          padding: 5px;
          font-weight: bold;
        "
      >
        > COMMAND.EXE
      </div>
      <div id="term-body">
        <div class="ln sys">Bios loaded...</div>
      </div>
      <div id="term-input-box">
        <button id="mic-btn" onclick="toggleVoice()" title="Voice Command">
          ðŸŽ¤
        </button>
        <span>></span
        ><input
          type="text"
          id="term-input"
          placeholder="Enter cmd..."
          autocomplete="off"
        />
      </div>
    </div>

    <div id="inspector">
      <h3
        style="color: var(--c-sec); font-family: var(--f-tech); margin-top: 0"
      >
        TARGET DETAILS
      </h3>
      <div id="insp-data"></div>
      <button
        onclick="document.getElementById('inspector').classList.remove('open')"
        style="
          width: 100%;
          margin-top: 15px;
          padding: 10px;
          background: transparent;
          border: 1px solid #555;
          color: #fff;
          cursor: pointer;
        "
      >
        CLOSE
      </button>
    </div>

    <div class="hud-grid">
      <div class="panel" style="border-color: var(--c-danger)">
        <h3>NEAREST THREAT</h3>
        <div
          style="
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
          "
        >
          <div
            id="dist-val"
            style="font-family: var(--f-tech); font-size: 2.5rem; color: #fff"
          >
            --
          </div>
          <div style="font-size: 0.8rem; color: var(--c-danger)">
            KILOMETERS
          </div>
          <div
            id="dist-name"
            style="font-size: 0.7rem; color: #888; margin-top: 10px"
          >
            GPS REQUIRED
          </div>
        </div>
      </div>

      <div class="panel">
        <h3>AI NEURAL LOSS</h3>
        <div style="flex: 1; width: 100%"><canvas id="lineChart"></canvas></div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            margin-top: 5px;
          "
        >
          <span>LOSS: <span id="val-loss" style="color: #fff">--</span></span>
          <span>PING: <span id="val-ping" style="color: #fff">--</span></span>
        </div>
      </div>

      <div class="panel">
        <h3>HAZARD RADAR</h3>
        <div style="flex: 1; width: 100%">
          <canvas id="radarChart"></canvas>
        </div>
      </div>

      <div class="panel">
        <div style="display: flex; justify-content: space-between">
          <h3>TACTICAL OPS</h3>
          <span
            id="scan-time"
            style="font-family: var(--f-code); color: var(--c-warn)"
            >60</span
          >
        </div>
        <div class="btn-matrix">
          <button class="hud-btn" onclick="locateUser()" id="btn-gps">
            â—Ž GPS FIND
          </button>
          <button class="hud-btn active quake" onclick="toggle('QUAKE', this)">
            [x] QUAKES
          </button>
          <button class="hud-btn active fire" onclick="toggle('FIRE', this)">
            [x] FIRES
          </button>
          <button class="hud-btn active storm" onclick="toggle('STORM', this)">
            [x] STORMS
          </button>
          <button class="hud-btn active nuke" onclick="toggle('NUKE', this)">
            [x] NUKES
          </button>
          <button
            class="hud-btn active ai"
            onclick="toggle('PREDICT', this)"
            style="grid-column: span 2; border-color: #fff"
          >
            ðŸ§  AI PREDICTION
          </button>
        </div>
        <div
          style="
            text-align: right;
            font-size: 0.7rem;
            color: #666;
            margin-top: 5px;
          "
        >
          AI: <span id="st-ai">IDLE</span> | GPS: <span id="st-gps">OFF</span>
        </div>
      </div>
    </div>

    <script>
      // --- CORE VARIABLES ---
      let world, timer;
      let isLive = false;
      let isTraining = false;
      let events = [],
        training = [];
      let userLoc = null;
      let model = null;
      let activeFilters = {
        QUAKE: true,
        FIRE: true,
        STORM: true,
        VOLCANO: true,
        NUKE: true,
        OTHER: true,
        PREDICT: false,
      };

      const nukes = [
        { lat: 37.42, lng: 141.03, name: "Fukushima" },
        { lat: 47.51, lng: 34.58, name: "Zaporizhzhia" },
        { lat: 35.21, lng: -120.85, name: "Diablo Canyon" },
        { lat: 37.09, lng: 129.38, name: "Hanul" },
        { lat: 51.01, lng: 2.13, name: "Gravelines" },
        { lat: 25.03, lng: 121.56, name: "Maanshan" },
      ];
      const sats = Array(150)
        .fill()
        .map(() => ({
          lat: (Math.random() - 0.5) * 180,
          lng: (Math.random() - 0.5) * 360,
          alt: 0.6 + Math.random() * 0.3,
          color: "#ffd700",
          type: "SATELLITE",
        }));

      // --- AUDIO ---
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      function sfx(freq, type, dur) {
        if (audioCtx.state === "suspended") audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        gain.gain.exponentialRampToValueAtTime(
          0.01,
          audioCtx.currentTime + dur
        );
        osc.start();
        osc.stop(audioCtx.currentTime + dur);
      }

      // --- LOGGING ---
      const termBody = document.getElementById("term-body");
      function log(txt, type = "sys") {
        const div = document.createElement("div");
        div.className = `ln ${type}`;
        div.innerText = `> ${txt}`;
        termBody.appendChild(div);
        termBody.scrollTop = termBody.scrollHeight;
      }

      // --- INITIALIZATION ---
      function bootSystem() {
        document.getElementById("start-screen").style.display = "none";
        sfx(600, "square", 0.2);
        log("System Booting...", "sys");
        initGlobe();
        initAI();
        fetchData();
        timer = setInterval(fetchData, 60000);
        startCountdown();
        document.getElementById("ticker-content").innerText =
          "SYSTEM ONLINE /// CONNECTING TO SATELLITE ARRAY /// LISTENING FOR SEISMIC EVENTS...";
      }

      function initGlobe() {
        world = Globe()(document.getElementById("globe-viz"))
          .globeImageUrl("//unpkg.com/three-globe/example/img/earth-dark.jpg")
          .bumpImageUrl(
            "//unpkg.com/three-globe/example/img/earth-topology.png"
          )
          .backgroundImageUrl(
            "//unpkg.com/three-globe/example/img/night-sky.png"
          )
          .atmosphereColor("#00ff66")
          .atmosphereAltitude(0.15)
          .pointAltitude("alt")
          .pointColor("color")
          .pointRadius(0.5)
          .pointsMerge(false)
          .ringColor("color")
          .ringMaxRadius("maxR")
          .ringPropagationSpeed("speed")
          .ringRepeatPeriod("period")
          .customLayerData(sats)
          .customThreeObjectUpdate((obj, d) => {
            Object.assign(obj.position, world.getCoords(d.lat, d.lng, d.alt));
            if (d.type === "SATELLITE") {
              d.lng += 0.2;
              if (d.lng > 180) d.lng = -180;
            }
          })
          .onPointClick((d) => {
            sfx(1000, "sine", 0.1);
            world.pointOfView({ lat: d.lat, lng: d.lng, altitude: 1.2 }, 1500);
            showInspector(d);
          });

        world.customThreeObject((d) => {
          if (d.type === "NUCLEAR PLANT")
            return new THREE.Mesh(
              new THREE.CylinderGeometry(0.5, 0.5, 2, 8),
              new THREE.MeshBasicMaterial({ color: "#ccff00" })
            );
          else if (d.type === "SATELLITE")
            return new THREE.Mesh(
              new THREE.SphereGeometry(0.3),
              new THREE.MeshBasicMaterial({ color: "#ffd700" })
            );
          else if (d.type === "USER_LOC")
            return new THREE.Mesh(
              new THREE.CylinderGeometry(0.2, 0.2, 3, 8),
              new THREE.MeshBasicMaterial({ color: "#00f3ff" })
            );
          else
            return new THREE.Mesh(
              new THREE.TetrahedronGeometry(1.2),
              new THREE.MeshBasicMaterial({ color: d.color })
            );
        });

        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.5;
      }

      // --- DATA FETCHING ---
      async function fetchData() {
        log("Scanning satellites...", "sys");
        try {
          const [q, n] = await Promise.all([
            fetch(
              "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson"
            ).then((r) => r.json()),
            fetch(
              "https://eonet.gsfc.nasa.gov/api/v3/events?status=open&days=20"
            ).then((r) => r.json()),
          ]);

          let ev = [],
            counts = { Q: 0, F: 0, S: 0, V: 0, N: 0 };
          training = [];

          if (q.features)
            q.features.forEach((f, i) => {
              const m = f.properties.mag;
              counts.Q++;
              const col = m > 6 ? "#ff003c" : m > 5 ? "#ffd700" : "#00f3ff";
              ev.push({
                lat: f.geometry.coordinates[1],
                lng: f.geometry.coordinates[0],
                alt: m * 0.05,
                color: col,
                type: `QUAKE M${m.toFixed(1)}`,
                val: m,
                place: f.properties.place,
                maxR: m > 5 ? m * 4 : 0,
                speed: 4,
                period: 1000,
              });
              if (i < 50) training.push({ x: i, y: m });
            });

          if (n.events)
            n.events.forEach((e) => {
              const c = e.categories[0].id;
              const g = e.geometry[0].coordinates;
              let col = "#fff",
                typ = "OTHER";
              if (c === "wildfires") {
                counts.F++;
                col = "#ff6600";
                typ = "FIRE";
              } else if (c === "severeStorms") {
                counts.S++;
                col = "#bd00ff";
                typ = "STORM";
              } else if (c === "volcanoes") {
                counts.V++;
                col = "#ffd700";
                typ = "VOLCANO";
              }

              ev.push({
                lat: g[1],
                lng: g[0],
                alt: 0.15,
                color: col,
                type: typ,
                val: 5,
                place: e.title,
                maxR: 0,
                speed: 2,
                period: 2000,
              });
            });

          nukes.forEach((k) => {
            counts.N++;
            ev.push({
              lat: k.lat,
              lng: k.lng,
              alt: 0.1,
              color: "#ccff00",
              type: "NUCLEAR PLANT",
              val: 10,
              place: k.name,
              maxR: 15,
              speed: 1,
              period: 3000,
            });
          });

          events = ev;
          updateStats(counts);
          trainAI();
          render();
          calcDist();
          log(`Synced ${ev.length} events.`, "sys");
        } catch (e) {
          log("Data Uplink Failed.", "err");
        }
      }

      function render() {
        let show = events.filter((d) => {
          if (d.type.includes("QUAKE")) return activeFilters.QUAKE;
          if (d.type.includes("FIRE")) return activeFilters.FIRE;
          if (d.type.includes("STORM")) return activeFilters.STORM;
          if (d.type.includes("VOLCANO")) return activeFilters.VOLCANO;
          if (d.type.includes("NUCLEAR")) return activeFilters.NUKE;
          if (d.type.includes("USER")) return true;
          return activeFilters.OTHER;
        });
        if (activeFilters.PREDICT) show = show.concat(genPredictions());
        if (userLoc) show.push(userLoc);
        world.pointsData(show);
        world.ringsData(show.filter((d) => d.maxR > 0));
      }

      async function initAI() {
        model = tf.sequential();
        model.add(tf.layers.dense({ units: 1, inputShape: [1] }));
        model.compile({
          loss: "meanSquaredError",
          optimizer: tf.train.adam(0.1),
        });
      }

      async function trainAI() {
        if (isTraining || training.length < 5) return;
        isTraining = true;
        document.getElementById("st-ai").innerText = "LEARNING...";
        document.getElementById("st-ai").style.color = "var(--c-warn)";
        const xs = tf.tensor2d(
          training.map((d) => d.x * 0.01),
          [training.length, 1]
        );
        const ys = tf.tensor2d(
          training.map((d) => d.y),
          [training.length, 1]
        );
        await model.fit(xs, ys, {
          epochs: 10,
          callbacks: {
            onEpochEnd: (e, l) => {
              if (e === 9) {
                document.getElementById("val-loss").innerText =
                  l.loss.toFixed(4);
                lineChart.data.datasets[0].data.push(l.loss);
                lineChart.data.datasets[0].data.shift();
                lineChart.update();
              }
            },
          },
        });
        isTraining = false;
        document.getElementById("st-ai").innerText = "STABLE";
        document.getElementById("st-ai").style.color = "var(--c-primary)";
        xs.dispose();
        ys.dispose();
      }

      function genPredictions() {
        if (!model) return [];
        const pred = model.predict(tf.tensor2d([0.5], [1, 1])).dataSync()[0];
        let preds = [];
        for (let i = 0; i < events.length; i += 10) {
          if (events[i].type.includes("QUAKE")) {
            preds.push({
              lat: events[i].lat,
              lng: events[i].lng,
              alt: 0.05,
              color: "#ffffff",
              type: "AI PREDICTION",
              val: pred,
              place: "High Risk Zone",
              maxR: 20,
              speed: 2,
              period: 1500,
            });
          }
        }
        return preds;
      }

      // --- COMMAND & VOICE ---
      const micBtn = document.getElementById("mic-btn");
      let recognition;

      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";
        recognition.onstart = () => {
          micBtn.classList.add("listening");
          log("Listening...", "voice");
        };
        recognition.onend = () => {
          micBtn.classList.remove("listening");
        };
        recognition.onresult = (event) => {
          const cmd = event.results[0][0].transcript.toLowerCase();
          log(`"${cmd}"`, "voice");
          processCommand(cmd);
        };
      }

      function toggleVoice() {
        if (recognition) recognition.start();
        else log("Voice not supported", "err");
      }

      document.getElementById("term-input").addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const cmd = e.target.value.trim().toLowerCase();
          log(cmd, "cmd");
          sfx(800, "triangle", 0.1);
          processCommand(cmd);
          e.target.value = "";
        }
      });

      function processCommand(cmd) {
        if (cmd.includes("scan")) fetchData();
        else if (cmd.includes("gps") || cmd.includes("locate")) locateUser();
        else if (cmd.includes("status")) log("Systems Nominal.", "sys");
        else if (cmd.includes("nuke"))
          toggle("NUKE", document.querySelector(".hud-btn.active.nuke"));
        else if (cmd.includes("help"))
          log("CMDS: scan, gps, status, nuke", "sys");
        else log("Unknown command.", "err");
      }

      // --- UI UTILS ---
      window.toggle = (key, btn) => {
        activeFilters[key] = !activeFilters[key];
        if (activeFilters[key]) btn.classList.add("active");
        else btn.classList.remove("active");
        sfx(800, "triangle", 0.05);
        render();
      };

      window.locateUser = () => {
        if (!navigator.geolocation) return log("GPS Error.", "err");
        document.getElementById("btn-gps").innerText = "LOCATING...";
        navigator.geolocation.getCurrentPosition((pos) => {
          userLoc = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            alt: 0.02,
            color: "#00f3ff",
            type: "USER_LOC",
            val: 0,
            place: "HOME BASE",
            maxR: 10,
            speed: 1,
            period: 2000,
          };
          document.getElementById("btn-gps").innerText = "GPS LOCKED";
          document.getElementById("st-gps").innerText = "LOCKED";
          document.getElementById("st-gps").style.color = "var(--c-sec)";
          log(
            `GPS Fixed: ${userLoc.lat.toFixed(2)}, ${userLoc.lng.toFixed(2)}`,
            "sys"
          );
          world.pointOfView(
            { lat: userLoc.lat, lng: userLoc.lng, altitude: 1.5 },
            1500
          );
          render();
          calcDist();
        });
      };

      function calcDist() {
        if (!userLoc) return;
        let minD = 99999,
          name = "";
        events.forEach((e) => {
          if (e.type.includes("USER") || e.type.includes("PREDICT")) return;
          const p = 0.017453292519943295;
          const a =
            0.5 -
            Math.cos((e.lat - userLoc.lat) * p) / 2 +
            (Math.cos(userLoc.lat * p) *
              Math.cos(e.lat * p) *
              (1 - Math.cos((e.lng - userLoc.lng) * p))) /
              2;
          const d = 12742 * Math.asin(Math.sqrt(a));
          if (d < minD) {
            minD = d;
            name = e.type + " " + e.place;
          }
        });
        document.getElementById("dist-val").innerText = Math.round(minD);
        document.getElementById("dist-name").innerText = name;
        const col =
          minD < 500
            ? "var(--c-danger)"
            : minD < 1500
            ? "var(--c-warn)"
            : "var(--c-primary)";
        document.getElementById("dist-val").style.color = col;
      }

      function updateStats(c) {
        radar.data.datasets[0].data = [c.Q, c.F, c.S, c.V, c.N];
        radar.update();
        let d = 5;
        if (c.Q > 50 || c.S > 5) d = 4;
        if (c.Q > 100 || c.N > 0) d = 3;
        const el = document.getElementById("defcon-val");
        el.innerText = "DEFCON " + d;
        el.style.color =
          d <= 3
            ? "var(--c-danger)"
            : d === 4
            ? "var(--c-warn)"
            : "var(--c-primary)";
      }

      function showInspector(d) {
        document.getElementById("inspector").classList.add("open");
        document.getElementById("insp-data").innerHTML = `
                <div class="insp-row"><span class="insp-lbl">TYPE</span><span class="insp-val" style="color:${
                  d.color
                }">${d.type}</span></div>
                <div class="insp-row"><span class="insp-lbl">LOC</span><span class="insp-val">${
                  d.place
                }</span></div>
                <div class="insp-row"><span class="insp-lbl">MAG</span><span class="insp-val">${d.val.toFixed(
                  1
                )}</span></div>
            `;
      }

      function startCountdown() {
        let t = 60;
        setInterval(() => {
          t--;
          if (t < 0) t = 60;
          document.getElementById("scan-time").innerText = t;
        }, 1000);
      }

      // --- CHARTS ---
      Chart.defaults.color = "#666";
      Chart.defaults.font.family = "VT323";
      const radar = new Chart(document.getElementById("radarChart"), {
        type: "polarArea",
        data: {
          labels: ["Q", "F", "S", "V", "N"],
          datasets: [
            {
              data: [0, 0, 0, 0, 0],
              backgroundColor: [
                "#00f3ff",
                "#ff6600",
                "#bd00ff",
                "#ffd700",
                "#ccff00",
              ],
              borderWidth: 0,
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { r: { display: false, max: 100 } },
          maintainAspectRatio: false,
        },
      });
      const lineChart = new Chart(document.getElementById("lineChart"), {
        type: "line",
        data: {
          labels: Array(20).fill(""),
          datasets: [
            {
              data: Array(20).fill(0),
              borderColor: "#00f3ff",
              borderWidth: 1,
              pointRadius: 0,
              tension: 0.4,
            },
          ],
        },
        options: {
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } },
          maintainAspectRatio: false,
        },
      });
    </script>
  </body>
</html>
