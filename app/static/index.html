<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta property="og:title" content="UPT Disaster AI - Guardian System" />
    <meta
      property="og:description"
      content="H·ªá th·ªëng theo d√µi th·∫£m h·ªça to√†n c·∫ßu & M√¥ ph·ªèng l√≤ ph·∫£n ·ª©ng l∆∞·ª£ng t·ª≠ Real-time."
    />
    <meta
      property="og:image"
      content="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c3/Nuclear_symbol.svg/1200px-Nuclear_symbol.svg.png"
    />
    <meta property="og:url" content="https://upt-disaster-ai.onrender.com/" />
    <meta name="theme-color" content="#00f3ff" />

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ò¢Ô∏è</text></svg>"
    />

    <script src="//unpkg.com/three@0.124.0/build/three.min.js"></script>
    <script src="//unpkg.com/globe.gl@2.26.4/dist/globe.gl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --neon-blue: #00f3ff;
        --neon-red: #ff003c;
        --neon-gold: #ffd700;
        --neon-green: #00ff66;
        --neon-orange: #ff6600;
        --neon-purple: #bd00ff;
        --neon-pink: #ff00cc;
        --neon-white: #ffffff;
        --neon-toxic: #ccff00;
        --glass-bg: rgba(8, 15, 25, 0.9);
        --glass-border: rgba(0, 243, 255, 0.3);
        --tech-font: "Orbitron", sans-serif;
        --data-font: "Rajdhani", sans-serif;
        --code-font: "VT323", monospace;
        --defcon-1: #ff0000;
        --defcon-2: #ff4400;
        --defcon-3: #ffcc00;
        --defcon-4: #00ff66;
        --defcon-5: #0088ff;
      }

      body {
        margin: 0;
        background-color: #000;
        color: var(--neon-blue);
        font-family: var(--data-font);
        overflow: hidden;
        height: 100vh;
        user-select: none;
        transition: box-shadow 1s ease;
      }
      body.alert-mode {
        box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.3);
      }

      .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.1) 50%,
          rgba(0, 0, 0, 0.1)
        );
        background-size: 100% 4px;
        opacity: 0.1;
      }

      #globe-viz {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      /* DEFCON BAR */
      #defcon-bar {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        height: 60px;
        z-index: 20;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid var(--neon-blue);
        border-top: none;
        clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        transition: 0.5s;
      }
      #defcon-level {
        font-family: var(--tech-font);
        font-size: 2rem;
        font-weight: 900;
        letter-spacing: 5px;
        color: var(--defcon-5);
        text-shadow: 0 0 15px currentColor;
      }

      /* AI TICKER */
      #ai-ticker {
        position: absolute;
        top: 65px;
        left: 0;
        width: 100%;
        height: 30px;
        z-index: 15;
        background: rgba(0, 20, 40, 0.9);
        border-top: 1px solid var(--neon-blue);
        border-bottom: 1px solid var(--neon-blue);
        display: flex;
        align-items: center;
        overflow: hidden;
        white-space: nowrap;
      }
      #ai-ticker-text {
        font-family: var(--code-font);
        font-size: 1.2rem;
        color: var(--neon-gold);
        padding-left: 100%;
        animation: ticker 20s linear infinite;
      }
      @keyframes ticker {
        0% {
          transform: translateX(0);
        }
        100% {
          transform: translateX(-100%);
        }
      }

      /* TERMINAL */
      #terminal {
        position: absolute;
        top: 110px;
        left: 20px;
        width: 350px;
        height: 35vh;
        background: rgba(0, 10, 10, 0.9);
        border: 1px solid #333;
        border-left: 3px solid var(--neon-green);
        font-family: var(--code-font);
        font-size: 1.1rem;
        color: var(--neon-green);
        display: flex;
        flex-direction: column;
        z-index: 20;
        box-shadow: 0 0 15px rgba(0, 255, 100, 0.1);
        backdrop-filter: blur(5px);
      }
      #term-output {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .term-line {
        margin-bottom: 2px;
      }
      .term-line.sys {
        color: #888;
      }
      .term-line.err {
        color: var(--neon-red);
      }
      .term-line.cmd {
        color: #fff;
      }
      .term-line.ai {
        color: var(--neon-purple);
        font-weight: bold;
      }
      .term-line.voice {
        color: var(--neon-gold);
        font-style: italic;
      }

      #term-input-line {
        display: flex;
        border-top: 1px solid #333;
        padding: 5px;
        background: rgba(0, 255, 100, 0.05);
      }
      #term-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: var(--code-font);
        font-size: 1.1rem;
        flex: 1;
        outline: none;
        margin-left: 5px;
        text-transform: lowercase;
      }
      #mic-btn {
        background: transparent;
        border: none;
        color: #888;
        cursor: pointer;
        font-size: 1.2rem;
        transition: 0.3s;
        margin-right: 5px;
      }
      #mic-btn:hover {
        color: #fff;
      }
      #mic-btn.listening {
        color: var(--neon-red);
        animation: pulseRed 1s infinite;
      }

      /* INSPECTOR */
      #inspector {
        position: absolute;
        top: 110px;
        right: -400px;
        width: 350px;
        background: rgba(5, 10, 15, 0.95);
        border: 1px solid var(--neon-blue);
        border-left: 4px solid var(--neon-blue);
        padding: 20px;
        z-index: 20;
        transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
        box-shadow: -10px 10px 30px rgba(0, 0, 0, 0.8);
      }
      #inspector.active {
        right: 20px;
      }
      .insp-row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 0;
        font-size: 0.9rem;
      }
      .insp-lbl {
        color: #888;
        font-size: 0.75rem;
        letter-spacing: 1px;
      }
      .insp-val {
        color: #fff;
        font-weight: 700;
        text-align: right;
      }
      .status-box {
        margin-top: 10px;
        padding: 8px;
        text-align: center;
        font-weight: bold;
        letter-spacing: 1px;
        background: rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
      }

      /* HUD */
      .hud-overlay {
        position: absolute;
        bottom: 15px;
        left: 15px;
        right: 15px;
        height: 28vh;
        display: grid;
        grid-template-columns: 0.8fr 1.5fr 1fr 1.2fr;
        gap: 10px;
        z-index: 10;
        pointer-events: none;
      }
      .panel {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        padding: 12px;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        clip-path: polygon(0 0, 100% 0, 100% 85%, 92% 100%, 0 100%);
        transition: 0.3s;
        min-height: 0;
      }
      .panel:hover {
        border-color: rgba(0, 243, 255, 0.8);
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
      }
      h3 {
        margin: 0 0 8px 0;
        font-family: var(--tech-font);
        font-size: 0.7rem;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        white-space: nowrap;
      }
      .big-stat {
        font-family: var(--tech-font);
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 0 20px var(--neon-blue);
        line-height: 1;
      }
      .sub-stat {
        font-size: 0.7rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
      }

      .btn-link {
        background: rgba(0, 243, 255, 0.1);
        border: 1px solid var(--neon-blue);
        color: var(--neon-blue);
        padding: 10px;
        font-size: 0.9rem;
        font-family: var(--tech-font);
        font-weight: bold;
        cursor: pointer;
        margin-top: auto;
        transition: 0.3s;
        clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
      }
      .btn-link.active {
        background: var(--neon-red);
        border-color: var(--neon-red);
        color: #fff;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 5px;
        margin-top: 5px;
      }
      .filter-btn {
        background: transparent;
        border: 1px solid #444;
        color: #666;
        cursor: pointer;
        padding: 5px;
        font-family: var(--code-font);
        font-size: 0.8rem;
        transition: 0.2s;
      }
      .filter-btn:hover {
        border-color: #fff;
        color: #fff;
      }
      .filter-btn.active {
        border-color: var(--neon-green);
        color: var(--neon-green);
        background: rgba(0, 255, 100, 0.1);
      }

      /* HELP OVERLAY */
      #help-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1000;
        background: rgba(0, 5, 10, 0.9);
        backdrop-filter: blur(8px);
        display: none;
        align-items: center;
        justify-content: center;
      }
      .help-box {
        width: 70%;
        max-width: 900px;
        background: rgba(10, 20, 30, 0.9);
        border: 2px solid var(--neon-blue);
        padding: 30px;
        font-family: var(--code-font);
        color: #ccc;
        box-shadow: 0 0 50px rgba(0, 243, 255, 0.1);
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 20px;
      }
      .help-col h4 {
        color: var(--neon-gold);
        border-bottom: 1px solid #444;
        padding-bottom: 5px;
        margin-top: 0;
        font-family: var(--tech-font);
      }
      .help-col ul {
        list-style: none;
        padding: 0;
      }
      .help-col li {
        margin-bottom: 8px;
        font-size: 1rem;
      }
      .cmd-key {
        color: #fff;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.1);
        padding: 2px 5px;
      }

      .countdown-ring {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 40px;
        height: 40px;
      }
    </style>
  </head>
  <body>
    <div class="scanlines"></div>
    <div id="globe-viz"></div>

    <div id="defcon-bar"><div id="defcon-level">DEFCON 5</div></div>

    <div id="ai-ticker">
      <div id="ai-ticker-text">
        INITIALIZING GUARDIAN PROTOCOL... ATOMIC WATCH ONLINE...
      </div>
    </div>

    <div id="help-overlay">
      <div class="help-box">
        <div class="help-col">
          <h4>GUARDIAN OPS</h4>
          <ul>
            <li><span class="cmd-key">locate</span> - FIND ME (GPS)</li>
            <li><span class="cmd-key">scan</span> - Refresh Data</li>
            <li><span class="cmd-key">train</span> - Force Retrain</li>
            <li><span class="cmd-key">sats</span> - Toggle Satellites</li>
          </ul>
        </div>
        <div class="help-col">
          <h4>NAVIGATION</h4>
          <ul>
            <li><span class="cmd-key">vietnam</span> - Focus VN</li>
            <li><span class="cmd-key">usa / japan</span> - Focus Key Areas</li>
            <li><span class="cmd-key">europe</span> - Focus EU</li>
            <li><span class="cmd-key">global</span> - Reset View</li>
          </ul>
        </div>
        <div class="help-col">
          <h4>TACTICAL</h4>
          <ul>
            <li><span class="cmd-key">show all</span> - Reveal Map</li>
            <li><span class="cmd-key">show nukes</span> - Nuclear Plants</li>
            <li><span class="cmd-key">predict</span> - Toggle AI Viz</li>
            <li><span class="cmd-key">mute / unmute</span> - Audio Control</li>
          </ul>
        </div>
        <div
          style="
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 20px;
            color: var(--neon-blue);
            border-top: 1px solid #333;
            padding-top: 10px;
          "
        >
          PRESS
          <span class="cmd-key" style="border-color: var(--neon-blue)">H</span>
          TO CLOSE
        </div>
      </div>
    </div>

    <div id="terminal">
      <div
        style="
          background: var(--neon-green);
          padding: 5px;
          font-size: 0.9rem;
          color: #000;
          font-weight: bold;
        "
      >
        root@upt-commander:~#
      </div>
      <div id="term-output">
        <div class="term-line sys">Guardian Kernel v27.4 loaded.</div>
        <div class="term-line sys">Module: AUTO_RESUME [PATCHED]</div>
        <div class="term-line">System Online.</div>
      </div>
      <div id="term-input-line">
        <button id="mic-btn" onclick="toggleVoice()" title="Voice Command">
          üé§
        </button>
        <span>></span
        ><input
          type="text"
          id="term-input"
          autocomplete="off"
          placeholder="_"
        />
      </div>
    </div>

    <div id="inspector">
      <h2
        style="
          font-family: var(--tech-font);
          color: var(--neon-blue);
          margin: 0 0 5px 0;
          font-size: 1rem;
        "
      >
        TARGET ANALYSIS
      </h2>
      <div
        style="
          width: 100%;
          height: 1px;
          background: var(--neon-blue);
          margin-bottom: 15px;
          opacity: 0.5;
        "
      ></div>
      <div id="inspector-content">Selecting...</div>
      <button
        onclick="window.closeInspector()"
        style="
          width: 100%;
          margin-top: 20px;
          background: transparent;
          border: 1px solid #555;
          color: #888;
          padding: 8px;
          cursor: pointer;
          font-family: var(--tech-font);
          font-size: 0.8rem;
        "
      >
        // DISMISS
      </button>
    </div>

    <div class="hud-overlay">
      <div class="panel">
        <h3>Nearest Threat</h3>
        <div
          style="
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
          "
        >
          <div id="val-prob" class="big-stat" style="font-size: 2rem">--</div>
          <div class="sub-stat" id="lbl-prob">DISTANCE (KM)</div>
          <div
            id="nearest-name"
            style="font-size: 0.7rem; color: #fff; margin-top: 5px"
          >
            AWAITING GPS
          </div>
        </div>
      </div>
      <div class="panel">
        <h3>Reactor Status (Live)</h3>
        <div style="flex: 1; width: 100%; min-height: 0">
          <canvas id="waveChart"></canvas>
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            color: #666;
          "
        >
          <span>FLUX: <span id="val-flux" style="color: #fff">--</span></span>
          <span>TEMP: <span id="val-temp" style="color: #fff">-- K</span></span>
        </div>
      </div>
      <div class="panel">
        <h3>Hazard Distribution</h3>
        <div style="flex: 1; width: 100%; min-height: 0">
          <canvas id="radarChart"></canvas>
        </div>
      </div>

      <div class="panel" style="border-color: rgba(255, 0, 60, 0.3)">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="color: var(--neon-red); margin: 0">Tactical Ops</h3>
          <div style="position: relative; width: 30px; height: 30px">
            <svg
              viewBox="0 0 36 36"
              style="width: 100%; height: 100%; transform: rotate(-90deg)"
            >
              <path
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="#333"
                stroke-width="4"
              />
              <path
                id="scan-circle"
                d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831"
                fill="none"
                stroke="var(--neon-green)"
                stroke-width="4"
                stroke-dasharray="100, 100"
              />
            </svg>
            <div
              id="scan-text"
              style="
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-family: 'VT323';
                color: #fff;
                font-size: 0.8rem;
              "
            >
              60
            </div>
          </div>
        </div>

        <div class="filter-grid">
          <button
            id="btn-gps"
            class="filter-btn"
            style="
              border-color: var(--neon-blue);
              color: var(--neon-blue);
              grid-column: span 2;
            "
            onclick="locateUser()"
          >
            [ ] LOCATE ME (GPS)
          </button>
          <button
            id="btn-quake"
            class="filter-btn active"
            onclick="toggleFilter('QUAKE', this)"
          >
            [x] QUAKES
          </button>
          <button
            id="btn-volcano"
            class="filter-btn active"
            onclick="toggleFilter('VOLCANO', this)"
          >
            [x] VOLCANO
          </button>
          <button
            id="btn-storm"
            class="filter-btn active"
            onclick="toggleFilter('STORM', this)"
          >
            [x] STORMS
          </button>
          <button
            id="btn-fire"
            class="filter-btn active"
            onclick="toggleFilter('FIRE', this)"
          >
            [x] FIRES
          </button>
          <button
            id="btn-other"
            class="filter-btn active"
            onclick="toggleFilter('OTHER', this)"
          >
            [x] OTHERS
          </button>
          <button
            id="btn-nuke"
            class="filter-btn active"
            style="border-color: var(--neon-toxic); color: var(--neon-toxic)"
            onclick="toggleFilter('NUKE', this)"
          >
            [x] NUKES
          </button>
          <button
            id="btn-predict"
            class="filter-btn"
            style="
              border-color: var(--neon-purple);
              color: var(--neon-purple);
              grid-column: span 2;
            "
            onclick="togglePrediction()"
          >
            [ ] NEURAL AI
          </button>
        </div>

        <div
          style="
            font-family: var(--code-font);
            color: #888;
            flex: 1;
            font-size: 0.8rem;
            padding: 5px;
            overflow: hidden;
          "
        >
          > REACTOR: <span id="status-model">OFFLINE</span><br />
          > USER_LOC: <span id="status-loc">UNKNOWN</span>
        </div>

        <button id="btn-link" class="btn-link">ACTIVATE REACTOR LINK</button>
      </div>
    </div>

    <script>
      // --- WEBSOCKET SETUP ---
      let socket = null;
      let isLive = false;
      let timer = null;
      let world;
      let currentDefcon = 5;
      let currentNodeCount = 0;
      let showSats = true;
      let allEventsCache = [];
      let activeFilters = {
        QUAKE: true,
        VOLCANO: true,
        STORM: true,
        FIRE: true,
        OTHER: true,
        NUKE: true,
        PREDICT: false,
      };
      let predictionEvents = [];
      let userLat = null;
      let userLng = null;
      let userEventMarker = null;

      const originalError = console.error;
      console.error = function (...args) {
        if (
          args[0] &&
          (args[0].toString().includes("t.map") ||
            args[0].toString().includes("pathOpacity"))
        )
          return;
        originalError.apply(console, args);
      };

      class AudioSynth {
        constructor() {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          this.muted = false;
        }
        playTone(freq, type, duration, vol = 0.1) {
          if (this.muted) return;
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
          gain.gain.setValueAtTime(vol, this.ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            this.ctx.currentTime + duration
          );
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + duration);
        }
        playBeep() {
          this.playTone(800, "sine", 0.1, 0.05);
        }
        playScan() {
          this.playTone(1200, "square", 0.05, 0.02);
        }
        playPredict() {
          this.playTone(600, "triangle", 0.3, 0.05);
        }
        playAlarm() {
          if (this.muted) return;
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = "sawtooth";
          osc.frequency.setValueAtTime(400, this.ctx.currentTime);
          osc.frequency.linearRampToValueAtTime(
            600,
            this.ctx.currentTime + 0.3
          );
          gain.gain.value = 0.1;
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + 0.5);
        }
      }
      const sfx = new AudioSynth();
      const termOut = document.getElementById("term-output");
      const termIn = document.getElementById("term-input");
      const micBtn = document.getElementById("mic-btn");
      let recognition;

      function printTerm(msg, type = "") {
        const div = document.createElement("div");
        div.className = `term-line ${type}`;
        div.innerText = `> ${msg}`;
        termOut.appendChild(div);
        termOut.scrollTop = termOut.scrollHeight;
      }

      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.onstart = function () {
          micBtn.classList.add("listening");
          printTerm("Listening...", "voice");
        };
        recognition.onend = function () {
          micBtn.classList.remove("listening");
        };
        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript.toLowerCase();
          printTerm(`"${transcript}"`, "voice");
          processCommand(transcript);
        };
      } else {
        micBtn.style.display = "none";
        printTerm("Voice API not supported.", "err");
      }

      function toggleVoice() {
        if (recognition) recognition.start();
      }

      document.addEventListener("keydown", (e) => {
        if (document.activeElement === termIn) {
          if (e.key === "Enter") {
            const cmd = termIn.value.trim().toLowerCase();
            printTerm(cmd, "cmd");
            processCommand(cmd);
            termIn.value = "";
            sfx.playBeep();
          }
          return;
        }
        if (e.key.toLowerCase() === "h") {
          const help = document.getElementById("help-overlay");
          help.style.display =
            help.style.display === "none" || help.style.display === ""
              ? "flex"
              : "none";
          sfx.playBeep();
        }
      });

      // --- COMMANDS ---
      function processCommand(cmd) {
        if (cmd.includes("scan")) {
          printTerm("Manual scan...", "sys");
          fetchAllData();
          return;
        }
        if (cmd.includes("locate") || cmd.includes("gps")) {
          locateUser();
          return;
        }
        if (cmd.includes("status")) {
          printTerm(`--- SYSTEM REPORT ---`, "sys");
          printTerm(`DEFCON LEVEL: ${currentDefcon}`, "sys");
          printTerm(`EVENTS: ${currentNodeCount}`, "sys");
          return;
        }
        if (cmd.includes("mute")) {
          sfx.muted = true;
          printTerm("Audio Muted.", "sys");
          return;
        }
        if (cmd.includes("unmute")) {
          sfx.muted = false;
          printTerm("Audio Enabled.", "sys");
          return;
        }

        // Manual rotation control command
        if (cmd.includes("stop")) {
          if (world) world.controls().autoRotate = false;
          printTerm("Rotation HALTED.", "sys");
          return;
        }
        if (cmd.includes("spin") || cmd.includes("rotate")) {
          if (world) world.controls().autoRotate = true;
          printTerm("Rotation RESUMED.", "sys");
          return;
        }

        const locs = {
          vietnam: { lat: 14.0, lng: 108.0, alt: 0.8 },
          usa: { lat: 37.0, lng: -95.0, alt: 1.0 },
          japan: { lat: 36.0, lng: 138.0, alt: 0.8 },
          europe: { lat: 54.0, lng: 15.0, alt: 1.2 },
          global: { lat: 0, lng: 0, alt: 2.5 },
        };
        for (const [key, val] of Object.entries(locs)) {
          if (cmd.includes(key)) {
            world.pointOfView(
              { lat: val.lat, lng: val.lng, altitude: val.alt },
              2000
            );
            printTerm(`Moving to ${key.toUpperCase()}`, "sys");
            return;
          }
        }
        if (cmd === "help")
          printTerm("Press 'H' for full command list.", "sys");
        else printTerm("Command not recognized.", "err");
      }

      // --- SATELLITE DATA (COLOR FIXED: WHITE GHOST) ---
      const satData = [...Array(150).keys()].map(() => ({
        lat: (Math.random() - 0.5) * 180,
        lng: (Math.random() - 0.5) * 360,
        alt: 0.6 + Math.random() * 0.3,
        velocity: Math.random() * 0.4 + 0.1,
        color: "rgba(200, 200, 255, 0.6)", // M√ÄU M·ªöI: Tr·∫Øng m·ªù
        type: "SATELLITE",
      }));

      const nuclearPlants = [
        { name: "Fukushima Daiichi", lat: 37.421, lng: 141.033, desc: "Japan" },
        { name: "Zaporizhzhia", lat: 47.512, lng: 34.586, desc: "Ukraine" },
        {
          name: "Kashiwazaki-Kariwa",
          lat: 37.429,
          lng: 138.596,
          desc: "Japan",
        },
        { name: "Diablo Canyon", lat: 35.211, lng: -120.855, desc: "USA" },
      ];

      // --- UPDATED: Stop Rotation on Toggle ---
      window.toggleFilter = (type, btn) => {
        // NG·ª™NG QUAY KHI B·∫§M N√öT
        if (world) world.controls().autoRotate = false;

        activeFilters[type] = !activeFilters[type];
        btn.innerText = activeFilters[type] ? `[x] ${type}S` : `[ ] ${type}S`;
        if (activeFilters[type]) btn.classList.add("active");
        else btn.classList.remove("active");
        sfx.playBeep();
        applyFilters();
      };

      // --- GPS ---
      window.locateUser = () => {
        const btn = document.getElementById("btn-gps");
        const statusLoc = document.getElementById("status-loc");
        if (navigator.geolocation) {
          printTerm("Triangulating...", "sys");
          btn.innerText = "[...] LOCATING";
          navigator.geolocation.getCurrentPosition(
            (position) => {
              userLat = position.coords.latitude;
              userLng = position.coords.longitude;
              btn.innerText = "[x] GPS LOCKED";
              btn.classList.add("active");
              statusLoc.innerText = `${userLat.toFixed(2)},${userLng.toFixed(
                2
              )}`;
              statusLoc.style.color = "var(--neon-blue)";
              printTerm(
                `GPS: ${userLat.toFixed(4)}, ${userLng.toFixed(4)}`,
                "sys"
              );
              sfx.playBeep();
              userEventMarker = {
                lat: userLat,
                lng: userLng,
                alt: 0.02,
                color: "#00f3ff",
                type: "USER_LOC",
                place: "HOME BASE",
                value: 0,
                desc: "Current User Location",
                maxR: 5,
                propagationSpeed: 1,
                repeatPeriod: 2000,
              };
              world.pointOfView(
                { lat: userLat, lng: userLng, altitude: 1.5 },
                2000
              );
              applyFilters();
              calcNearestThreat();
            },
            () => {
              printTerm("GPS Failed.", "err");
              btn.innerText = "[!] GPS FAIL";
            }
          );
        } else {
          printTerm("Geolocation not supported.", "err");
        }
      };

      function calcNearestThreat() {
        if (userLat === null || allEventsCache.length === 0) return;
        let minDist = 999999;
        let nearestEvent = null;
        allEventsCache.forEach((e) => {
          if (e.type === "USER_LOC") return;
          const dist = getDistance(userLat, userLng, e.lat, e.lng);
          if (dist < minDist) {
            minDist = dist;
            nearestEvent = e;
          }
        });
        if (nearestEvent) {
          document.getElementById("val-prob").innerText =
            Math.round(minDist).toLocaleString();
          document.getElementById(
            "nearest-name"
          ).innerText = `${nearestEvent.type} - ${nearestEvent.place}`;
        }
      }
      function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      window.togglePrediction = () => {
        // Placeholder
        printTerm("Neural AI module is in maintenance.", "sys");
      };

      function applyFilters() {
        let filteredData = allEventsCache.filter((d) => {
          if (d.type.includes("USER_LOC")) return true;
          if (d.type.includes("QUAKE")) return activeFilters["QUAKE"];
          if (d.type.includes("VOLCANO")) return activeFilters["VOLCANO"];
          if (d.type.includes("STORM") && d.color === "#bd00ff")
            return activeFilters["STORM"];
          if (d.type.includes("WILDFIRE")) return activeFilters["FIRE"];
          if (d.type.includes("NUCLEAR")) return activeFilters["NUKE"];
          if (d.type.includes("OTHER EVENT")) return activeFilters["OTHER"];
          return false;
        });
        if (userEventMarker) filteredData.push(userEventMarker);

        if (world) {
          world.pointsData(filteredData);
          world.ringsData(filteredData.filter((d) => d.maxR > 0));
        }
      }

      // --- WORLD INIT ---
      try {
        world = Globe()(document.getElementById("globe-viz"))
          .globeImageUrl("//unpkg.com/three-globe/example/img/earth-dark.jpg")
          .bumpImageUrl(
            "//unpkg.com/three-globe/example/img/earth-topology.png"
          )
          .backgroundImageUrl(
            "//unpkg.com/three-globe/example/img/night-sky.png"
          )
          .atmosphereColor("#00f3ff")
          .atmosphereAltitude(0.2)
          .pointAltitude("alt")
          .pointColor("color")
          .pointRadius(0.5)
          .pointsMerge(false)
          .ringColor("color")
          .ringMaxRadius("maxR")
          .ringPropagationSpeed("propagationSpeed")
          .ringRepeatPeriod("repeatPeriod")
          .customLayerData(satData)
          .customThreeObjectUpdate((obj, d) => {
            Object.assign(obj.position, world.getCoords(d.lat, d.lng, d.alt));
            obj.rotation.y += 0.1;
            if (d.lng) {
              d.lng += d.velocity || 0;
              if (d.lng > 180) d.lng = -180;
            }
          })
          .onPointClick((d) => {
            sfx.playBeep();

            // NG·ª™NG QUAY KHI CLICK V√ÄO ƒêI·ªÇM
            if (world) world.controls().autoRotate = false;

            world.pointOfView({ lat: d.lat, lng: d.lng, altitude: 1.2 }, 1500);
            showInspector(d);
          });

        world.customThreeObject((d) => {
          const geometry =
            d.type === "NUCLEAR PLANT"
              ? new THREE.CylinderGeometry(0.5, 0.5, 2, 8)
              : new THREE.TetrahedronGeometry(1.2);
          const material = new THREE.MeshBasicMaterial({ color: d.color });
          return new THREE.Mesh(geometry, material);
        });
        world.controls().autoRotate = true;
        // --- CH·ªàNH T·ªêC ƒê·ªò QUAY T·∫†I ƒê√ÇY ---
        world.controls().autoRotateSpeed = 0.15; // C·ª±c ch·∫≠m (Slow Motion)
      } catch (e) {
        console.error(e);
      }

      // --- CHARTS ---
      Chart.defaults.color = "#666";
      Chart.defaults.font.family = "Rajdhani";
      const waveChart = new Chart(document.getElementById("waveChart"), {
        type: "line",
        data: {
          labels: Array(30).fill(""),
          datasets: [
            {
              data: Array(30).fill(0),
              borderColor: "#00f3ff",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.5,
              fill: true,
              backgroundColor: "rgba(0,243,255,0.1)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: { x: { display: false }, y: { display: false } },
          animation: { duration: 0 },
        },
      });
      const radarChart = new Chart(document.getElementById("radarChart"), {
        type: "polarArea",
        data: {
          labels: ["Quake", "Fire", "Volcano", "Storm", "Other"],
          datasets: [
            {
              data: [0, 0, 0, 0, 0],
              backgroundColor: [
                "#00f3ff",
                "#ff6600",
                "#ffd700",
                "#bd00ff",
                "#ffffff",
              ],
              borderWidth: 1,
              borderColor: "#111",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "right",
              labels: { color: "#ccc", boxWidth: 10, font: { size: 9 } },
            },
          },
          scales: { r: { grid: { color: "#333" }, ticks: { display: false } } },
        },
      });

      // --- DATA FETCHING (EARTHQUAKE) ---
      async function fetchAllData() {
        try {
          const quakePromise = fetch(
            "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson"
          ).then((r) => r.json());
          const nasaPromise = fetch(
            "https://eonet.gsfc.nasa.gov/api/v3/events?status=open&days=20"
          ).then((r) => r.json());
          const [quakeData, nasaData] = await Promise.all([
            quakePromise,
            nasaPromise,
          ]);
          processMultiData(quakeData, nasaData);
        } catch (e) {
          console.error(e);
          printTerm("Data link unstable.", "err");
        }
      }

      function processMultiData(quakeData, nasaData) {
        let combinedEvents = [];
        let counts = { QUAKE: 0, FIRE: 0, VOLCANO: 0, STORM: 0, ICE: 0 };
        let maxIntensity = 0;

        // X·ª≠ l√Ω Earthquake
        if (quakeData.features) {
          quakeData.features.forEach((f) => {
            const mag = f.properties.mag;
            if (mag > maxIntensity) maxIntensity = mag;
            counts.QUAKE++;
            let color = mag > 7 ? "#ff003c" : mag > 5 ? "#ffd700" : "#00f3ff";
            combinedEvents.push({
              lat: f.geometry.coordinates[1],
              lng: f.geometry.coordinates[0],
              alt: mag * 0.05,
              color: color,
              type: `QUAKE (M${mag.toFixed(1)})`,
              place: f.properties.place,
              value: mag,
              desc: "Seismic Activity",
              maxR: mag > 5 ? mag * 5 : 0,
              propagationSpeed: 5,
              repeatPeriod: 800,
            });
          });
        }

        // X·ª≠ l√Ω NASA (COLOR FIX APPLIED)
        if (nasaData.events) {
          nasaData.events.forEach((e) => {
            if (!e.geometry || !e.categories) return;
            const catId = e.categories[0].id;
            const coords = e.geometry[0].coordinates;
            let lat = coords[1];
            let lng = coords[0];
            let color = "#aaaaaa";
            let type = "OTHER";
            let alt = 0.2;

            if (catId === "wildfires") {
              counts.FIRE++;
              color = "#ff6600";
              type = "WILDFIRE";
              alt = 0.3;
            } else if (catId === "volcanoes") {
              counts.VOLCANO++;
              color = "#ff00cc"; // M√ÄU M·ªöI: H·ªíNG NEON (Pink)
              type = "VOLCANO";
              alt = 0.5;
            } else if (catId === "severeStorms") {
              counts.STORM++;
              color = "#bd00ff";
              type = "STORM";
              alt = 0.4;
            }

            if (type !== "OTHER") {
              combinedEvents.push({
                lat: lat,
                lng: lng,
                alt: alt,
                color: color,
                type: type,
                place: e.title,
                value: 5.0,
                desc: "Active NASA Event",
                maxR: 0,
                propagationSpeed: 5,
                repeatPeriod: 800,
              });
            }
          });
        }

        nuclearPlants.forEach((n) => {
          combinedEvents.push({
            lat: n.lat,
            lng: n.lng,
            alt: 0.1,
            color: "#ccff00",
            type: "NUCLEAR PLANT",
            place: n.name,
            value: 10,
            desc: n.desc,
            maxR: 20,
            propagationSpeed: 1,
            repeatPeriod: 3000,
          });
        });

        allEventsCache = combinedEvents;
        currentNodeCount = combinedEvents.length;
        document.getElementById("val-prob").innerText = combinedEvents.length;

        // Update Charts
        radarChart.data.datasets[0].data = [
          counts.QUAKE,
          counts.FIRE,
          counts.VOLCANO,
          counts.STORM,
          counts.ICE,
        ];
        radarChart.update();

        applyFilters();
        printTerm(`Synced ${combinedEvents.length} events.`);
      }

      function showInspector(d) {
        document.getElementById("inspector").classList.add("active");
        document.getElementById("inspector-content").innerHTML = `
            <div class="insp-row"><span class="insp-lbl">CLASS</span> <strong style="color:${d.color}">${d.type}</strong></div>
            <div class="insp-row"><span class="insp-lbl">LOC</span> <span class="insp-val" style="font-size:0.8rem;">${d.place}</span></div>
            <div class="insp-row"><span class="insp-lbl">VAL</span> <span class="insp-val" style="color:${d.color}">${d.value}</span></div>
        `;
      }

      // --- C·∫¨P NH·∫¨T: AUTO-RESUME KHI ƒê√ìNG B·∫¢NG ---
      window.closeInspector = () => {
        document.getElementById("inspector").classList.remove("active");
        if (world) {
          world.controls().autoRotate = true; // Quay ti·∫øp
          world.pointOfView({ altitude: 2.5 }, 2000); // Zoom out v·ªÅ m·∫∑c ƒë·ªãnh cho ƒë·∫πp
        }
      };

      // --- MAIN BUTTON: WEBSOCKET TOGGLE ---
      document.getElementById("btn-link").addEventListener("click", () => {
        const btn = document.getElementById("btn-link");
        isLive = !isLive;

        if (isLive) {
          btn.classList.add("active");
          btn.innerText = "LINK ESTABLISHED";
          printTerm("Initializing Quantum Uplink (WebSocket)...");
          sfx.playBeep();

          // Start fetching map data
          fetchAllData();
          timer = setInterval(fetchAllData, 60000);

          // --- WEBSOCKET CONNECTION ---
          const protocol =
            window.location.protocol === "https:" ? "wss:" : "ws:";
          const wsUrl = `${protocol}//${window.location.host}/api/v1/reactor/ws/status`;

          socket = new WebSocket(wsUrl);

          socket.onopen = () => {
            printTerm("WebSocket Connected.", "sys");
            document.getElementById("status-model").innerText = "ONLINE";
            document.getElementById("status-model").style.color =
              "var(--neon-green)";
          };

          socket.onmessage = (event) => {
            const data = JSON.parse(event.data);

            document.getElementById("val-flux").innerText = data.neutron_flux;
            document.getElementById("val-temp").innerText =
              data.core_temp + " K";

            waveChart.data.datasets[0].data.push(data.k_eff);
            waveChart.data.datasets[0].data.shift();
            waveChart.update();

            if (data.core_temp > 2000) {
              document.getElementById("status-model").innerText = "CRITICAL";
              document.getElementById("status-model").style.color = "red";
              sfx.playAlarm();
            } else if (data.status === "SEISMIC WARNING") {
              document.getElementById("status-model").innerText =
                "SEISMIC ALERT";
              document.getElementById("status-model").style.color = "orange";
            } else {
              document.getElementById("status-model").innerText = data.status;
              document.getElementById("status-model").style.color =
                "var(--neon-green)";
            }
          };

          socket.onclose = () => {
            printTerm("WebSocket Disconnected.", "err");
            document.getElementById("status-model").innerText = "OFFLINE";
          };
        } else {
          // Disconnect
          btn.classList.remove("active");
          btn.innerText = "ACTIVATE REACTOR LINK";
          if (timer) clearInterval(timer);
          if (socket) socket.close();
          printTerm("Uplink Terminated.");
          document.getElementById("status-model").innerText = "OFFLINE";
          document.getElementById("status-model").style.color = "#888";
        }
      });

      setInterval(() => {
        let val = parseInt(document.getElementById("scan-text").innerText);
        val = val > 0 ? val - 1 : 60;
        document.getElementById("scan-text").innerText = val;
        document.getElementById("scan-circle").style.strokeDashoffset =
          100 - (val / 60) * 100;
      }, 1000);
    </script>
  </body>
</html>
