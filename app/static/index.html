<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT COMMANDER // V6.0</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #00f3ff; /* Cyan */
        --danger: #ff003c; /* Cyberpunk Red */
        --warn: #fcee0a; /* Yellow */
        --bg: #020408;
        --glass: rgba(2, 4, 8, 0.85);
        --border: 1px solid rgba(0, 243, 255, 0.3);
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--primary);
        font-family: "Share Tech Mono", monospace;
        overflow: hidden;
        height: 100vh;
        background-image: radial-gradient(
          circle at 50% 50%,
          #112 0%,
          #000 100%
        );
      }

      /* --- 1. LAYOUT GRID --- */
      .grid-container {
        display: grid;
        grid-template-rows: 60vh 40vh;
        height: 100vh;
        position: relative;
      }

      /* --- 2. MAP AREA --- */
      #map-wrapper {
        position: relative;
        border-bottom: 2px solid var(--primary);
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.1);
      }
      #map {
        height: 100%;
        width: 100%;
        filter: grayscale(90%) contrast(1.2) invert(10%);
        z-index: 1;
      }

      /* Grid Overlay Effect */
      .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 2;
        background: linear-gradient(
            rgba(0, 243, 255, 0.05) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
        background-size: 40px 40px;
      }

      /* --- 3. HUD CONTROL AREA --- */
      .hud {
        display: flex;
        gap: 15px;
        padding: 15px;
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
      }
      .panel {
        border: var(--border);
        background: rgba(0, 20, 40, 0.6);
        padding: 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        clip-path: polygon(
          0 0,
          100% 0,
          100% 90%,
          95% 100%,
          0 100%
        ); /* Cắt góc tech style */
      }
      .panel h3 {
        margin: 0 0 10px 0;
        color: var(--primary);
        font-family: "Orbitron";
        font-size: 0.9rem;
        letter-spacing: 2px;
        border-bottom: 1px dashed #333;
      }

      /* --- 4. SIDE INSPECTOR (Bảng chi tiết bên phải) --- */
      #inspector {
        position: absolute;
        top: 0;
        right: -350px;
        width: 320px;
        height: 60vh;
        background: rgba(0, 10, 15, 0.95);
        border-left: 2px solid var(--primary);
        z-index: 999;
        transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        padding: 20px;
        overflow-y: auto;
        box-shadow: -10px 0 30px rgba(0, 0, 0, 0.8);
      }
      #inspector.active {
        right: 0;
      }
      .inspector-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        border-bottom: 1px solid #222;
        padding-bottom: 5px;
      }
      .inspector-label {
        color: #888;
      }
      .inspector-val {
        color: #fff;
        font-weight: bold;
      }

      /* --- 5. VISUAL ELEMENTS --- */
      .big-stat {
        font-family: "Orbitron";
        font-size: 3.5rem;
        color: #fff;
        text-shadow: 0 0 20px var(--primary);
        line-height: 1;
      }
      .btn-action {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 15px;
        font-family: "Orbitron";
        cursor: pointer;
        margin-top: auto;
        text-transform: uppercase;
        letter-spacing: 2px;
        transition: 0.2s;
        font-weight: bold;
      }
      .btn-action:hover {
        background: var(--primary);
        color: #000;
        box-shadow: 0 0 20px var(--primary);
      }
      .btn-action.active {
        background: var(--danger);
        border-color: var(--danger);
        color: #fff;
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(255, 0, 60, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 60, 0);
        }
      }

      /* Sliders */
      input[type="range"] {
        appearance: none; /* <--- THÊM DÒNG NÀY ĐẦU TIÊN (Chuẩn quốc tế) */
        -webkit-appearance: none; /* Dòng này cho Chrome/Safari (VS Code sẽ hết báo vàng khi có dòng trên) */
        width: 100%;
        background: transparent;
        margin: 10px 0;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 16px;
        width: 6px;
        background: var(--primary);
        cursor: pointer;
        margin-top: -6px;
        border: 1px solid #fff;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #333;
      }

      /* Logs */
      #log-box {
        font-size: 0.75rem;
        height: 100%;
        overflow-y: auto;
        font-family: "Courier New";
        scrollbar-width: thin;
      }
      .log-item {
        margin-bottom: 4px;
        border-left: 2px solid #333;
        padding-left: 5px;
      }
      .log-crit {
        border-color: var(--danger);
        color: var(--danger);
        text-shadow: 0 0 5px var(--danger);
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <div id="map-wrapper">
        <div class="grid-overlay"></div>
        <div id="map"></div>
        <div id="inspector">
          <h2
            style="
              color: var(--primary);
              font-family: 'Orbitron';
              border-bottom: 2px solid var(--primary);
            "
          >
            TARGET ANALYSIS
          </h2>
          <div id="inspector-content">
            <div style="text-align: center; padding: 20px; color: #666">
              SELECT A TARGET ON MAP
            </div>
          </div>
          <button
            onclick="closeInspector()"
            style="
              width: 100%;
              margin-top: 20px;
              background: transparent;
              border: 1px solid #666;
              color: #666;
              cursor: pointer;
            "
          >
            CLOSE
          </button>
        </div>
      </div>

      <div class="hud">
        <div class="panel" style="flex: 1">
          <h3>// SYSTEM CONTROLS</h3>
          <div style="margin-bottom: 15px">
            <div style="display: flex; justify-content: space-between">
              <span>ENERGY (E)</span> <span id="lbl-e">0.50</span>
            </div>
            <input
              type="range"
              id="in-e"
              min="0"
              max="1"
              step="0.01"
              value="0.5"
              oninput="uiUpdate(this)"
            />
          </div>
          <div style="margin-bottom: 15px">
            <div style="display: flex; justify-content: space-between">
              <span>ANOMALY (A)</span> <span id="lbl-a">0.50</span>
            </div>
            <input
              type="range"
              id="in-a"
              min="0"
              max="1"
              step="0.01"
              value="0.5"
              oninput="uiUpdate(this)"
            />
          </div>
          <button id="btn-link" class="btn-action" onclick="toggleSystem()">
            INITIALIZE LINK
          </button>
        </div>

        <div class="panel" style="flex: 1; text-align: center">
          <h3>// PROBABILITY INDEX</h3>
          <div id="val-prob" class="big-stat">--%</div>
          <div
            id="val-status"
            style="margin-top: 10px; font-weight: bold; letter-spacing: 3px"
          >
            STANDBY
          </div>
        </div>

        <div class="panel" style="flex: 1.5">
          <h3>// TACTICAL LOG</h3>
          <div id="log-box">
            <div class="log-item">System V6.0 Loaded.</div>
            <div class="log-item">Waiting for operator input...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- 1. INITIALIZATION ---
      const map = L.map("map", {
        zoomControl: false,
        attributionControl: false,
      }).setView([20, 10], 2);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      ).addTo(map);

      let heatLayer = L.heatLayer([], {
        radius: 25,
        blur: 15,
        maxZoom: 10,
      }).addTo(map);
      let markersGroup = L.layerGroup().addTo(map);

      let isLive = false;
      let intervalId = null;
      let lastAlert = "";

      // --- 2. AUDIO SYSTEM (VOICE ALERT) ---
      function speak(text) {
        if ("speechSynthesis" in window) {
          const utterance = new SpeechSynthesisUtterance(text);
          utterance.lang = "en-US";
          utterance.rate = 1.1;
          utterance.pitch = 0.8; // Giọng trầm robot
          window.speechSynthesis.speak(utterance);
        }
      }

      // --- 3. UI FUNCTIONS ---
      function uiUpdate(el) {
        el.previousElementSibling.lastElementChild.innerText = parseFloat(
          el.value
        ).toFixed(2);
        if (!isLive) simulate();
      }

      function log(msg, type = "") {
        const box = document.getElementById("log-box");
        const time = new Date().toLocaleTimeString("en-GB");
        box.innerHTML += `<div class="log-item ${type}">[${time}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
      }

      function showInspector(data) {
        const p = document.getElementById("inspector");
        const c = document.getElementById("inspector-content");
        p.classList.add("active");

        // Render chi tiết
        c.innerHTML = `
                <div class="inspector-row"><span class="inspector-label">LOCATION</span> <span class="inspector-val" style="text-align:right">${
                  data.place
                }</span></div>
                <div class="inspector-row"><span class="inspector-label">MAGNITUDE</span> <span class="inspector-val" style="color:var(--primary)">${(
                  data.energy_level * 10
                ).toFixed(1)}</span></div>
                <div class="inspector-row"><span class="inspector-label">UPT ENERGY</span> <span class="inspector-val">${
                  data.energy_level
                }</span></div>
                <div class="inspector-row"><span class="inspector-label">ANOMALY SCORE</span> <span class="inspector-val">${
                  data.anomaly_score
                }</span></div>
                <div class="inspector-row"><span class="inspector-label">DEPTH</span> <span class="inspector-val">10.0 km</span></div>
                <div class="inspector-row"><span class="inspector-label">COORDINATES</span> <span class="inspector-val">${data.lat.toFixed(
                  2
                )}, ${data.lon.toFixed(2)}</span></div>
                <div style="margin-top:20px; border: 1px solid var(--danger); padding:10px; color:var(--danger); text-align:center; font-weight:bold;">
                    SUGGESTED ACTION: <br>${
                      data.energy_level > 0.5 ? "EVACUATE" : "MONITOR"
                    }
                </div>
            `;
      }

      function closeInspector() {
        document.getElementById("inspector").classList.remove("active");
      }

      // --- 4. CORE LOGIC ---
      async function toggleSystem() {
        isLive = !isLive;
        const btn = document.getElementById("btn-link");

        if (isLive) {
          btn.classList.add("active");
          btn.innerText = "TERMINATE LINK";
          document.getElementById("in-e").disabled = true;
          document.getElementById("in-a").disabled = true;
          log("SATELLITE UPLINK ESTABLISHED.", "log-crit");
          speak("System online. Satellite link established.");

          fetchData();
          intervalId = setInterval(fetchData, 8000);
        } else {
          btn.classList.remove("active");
          btn.innerText = "INITIALIZE LINK";
          document.getElementById("in-e").disabled = false;
          document.getElementById("in-a").disabled = false;
          clearInterval(intervalId);
          log("LINK OFFLINE.");
        }
      }

      async function fetchData() {
        try {
          const res = await fetch("/api/v1/disaster/realtime/usgs");
          const data = await res.json();

          if (data.upt_metrics) {
            processData(data);
          }
        } catch (e) {
          log("Connection Error.");
        }
      }

      function processData(data) {
        // 1. Update Metrics
        const prob = data.upt_metrics.probability_index * 100;
        document.getElementById("val-prob").innerText = prob.toFixed(1) + "%";

        const statusEl = document.getElementById("val-status");
        const alertLevel = data.upt_metrics.alert_level;
        statusEl.innerText = alertLevel;

        // 2. Audio Alert Logic
        if (alertLevel === "CRITICAL") {
          document.getElementById("val-prob").style.color = "var(--danger)";
          statusEl.style.color = "var(--danger)";
          if (lastAlert !== "CRITICAL") {
            speak("Warning. Critical Collapse Probability detected.");
            lastAlert = "CRITICAL";
          }
        } else {
          document.getElementById("val-prob").style.color = "#fff";
          statusEl.style.color = "var(--primary)";
          lastAlert = "NORMAL";
        }

        // 3. Update Sliders (Auto-Pilot)
        let maxE = 0,
          maxA = 0;
        let heatPoints = [];
        markersGroup.clearLayers();

        data.raw_sensors.forEach((s) => {
          if (s.energy_level > maxE) maxE = s.energy_level;
          if (s.anomaly_score > maxA) maxA = s.anomaly_score;

          // Tạo điểm Heatmap: [lat, lon, intensity]
          heatPoints.push([s.lat, s.lon, s.energy_level * 2]); // *2 để đậm hơn

          // Vẽ Marker tương tác
          let color = s.energy_level > 0.5 ? "#ff003c" : "#00f3ff";
          L.circleMarker([s.lat, s.lon], {
            radius: s.energy_level * 20,
            color: color,
            fillColor: color,
            fillOpacity: 0.4,
          })
            .addTo(markersGroup)
            .on("click", () => showInspector(s));
        });

        // Update UI
        document.getElementById("in-e").value = maxE;
        document.getElementById("lbl-e").innerText = maxE.toFixed(2);
        document.getElementById("in-a").value = maxA;
        document.getElementById("lbl-a").innerText = maxA.toFixed(2);

        // Update Heatmap Layer
        heatLayer.setLatLngs(heatPoints);

        log(`Synced ${data.raw_sensors.length} sensors. Max Energy: ${maxE}`);
      }

      function simulate() {
        // Manual mode logic (simple visuals)
        let val = document.getElementById("in-e").value;
        document.getElementById("val-prob").innerText =
          (val * 80).toFixed(1) + "%";
      }
    </script>
  </body>
</html>
