<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT QUANTUM CORE // LIVE MONITOR</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --neon-green: #0f0;
        --neon-red: #f00;
        --neon-blue: #0ff;
        --neon-yellow: #ff0;
        --bg-color: #050a10;
        --glass: rgba(10, 20, 30, 0.9);
      }

      body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        background-image: linear-gradient(
            rgba(0, 255, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
        color: var(--neon-green);
        font-family: "Share Tech Mono", monospace;
        overflow: hidden;
        height: 100vh;
      }

      /* MAP */
      #map-container {
        position: relative;
        height: 60vh;
        border-bottom: 2px solid var(--neon-blue);
      }
      #map {
        height: 100%;
        width: 100%;
        filter: grayscale(85%) contrast(1.2) invert(10%);
      }
      .scan-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: rgba(0, 255, 255, 0.8);
        box-shadow: 0 0 15px var(--neon-blue);
        z-index: 999;
        animation: scan 4s infinite linear;
        pointer-events: none;
      }
      @keyframes scan {
        0% {
          top: 0%;
          opacity: 0;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }

      /* HUD */
      .hud-container {
        display: flex;
        height: 40vh;
        padding: 10px;
        gap: 10px;
        box-sizing: border-box;
      }
      .panel {
        border: 1px solid var(--neon-blue);
        background: var(--glass);
        padding: 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      h2 {
        margin: 0 0 10px 0;
        color: var(--neon-blue);
        font-family: "Orbitron";
        font-size: 1rem;
        border-bottom: 1px dashed #333;
      }

      /* SLIDERS */
      .control-group {
        margin-bottom: 8px;
      }
      label {
        display: flex;
        justify-content: space-between;
        font-size: 0.8rem;
      }
      input[type="range"] {
        appearance: none;
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 10px;
        width: 10px;
        background: var(--neon-blue);
        cursor: pointer;
        margin-top: -4px;
        box-shadow: 0 0 5px var(--neon-blue);
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 2px;
        background: #333;
      }

      /* LOGS & METRICS */
      #log-window {
        flex: 1;
        font-size: 0.75rem;
        overflow-y: auto;
        border: 1px solid #333;
        padding: 5px;
        background: #000;
        font-family: "Courier New";
      }
      .log-entry {
        margin-bottom: 2px;
        border-bottom: 1px solid #111;
      }
      .log-time {
        color: #666;
      }
      .log-crit {
        color: var(--neon-red);
      }
      .log-ok {
        color: var(--neon-green);
      }

      .big-stat {
        font-family: "Orbitron";
        font-size: 2.5rem;
        color: white;
        text-align: center;
      }
      .sub-stat {
        text-align: center;
        font-size: 0.8rem;
        color: #888;
      }

      /* BUTTONS */
      .btn-live {
        background: transparent;
        border: 1px solid var(--neon-green);
        color: var(--neon-green);
        padding: 10px;
        font-family: "Orbitron";
        cursor: pointer;
        margin-top: auto;
        transition: 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .btn-live:hover,
      .active-mode {
        background: var(--neon-green);
        color: black;
        box-shadow: 0 0 15px var(--neon-green);
      }
    </style>
  </head>
  <body>
    <div id="map-container">
      <div class="scan-line"></div>
      <div id="map"></div>
    </div>

    <div class="hud-container">
      <div class="panel" style="flex: 0.8">
        <h2>// PARAMETERS</h2>
        <div class="control-group">
          <label>ENERGY (E) <span id="val-energy">0.00</span></label
          ><input
            type="range"
            id="in-energy"
            min="0"
            max="1"
            step="0.01"
            value="0.5"
            oninput="updateUI(this)"
          />
        </div>
        <div class="control-group">
          <label>ANOMALY (A) <span id="val-anomaly">0.00</span></label
          ><input
            type="range"
            id="in-anomaly"
            min="0"
            max="1"
            step="0.01"
            value="0.5"
            oninput="updateUI(this)"
          />
        </div>
        <button id="btn-live" class="btn-live" onclick="toggleLiveMode()">
          [ CONNECT SATELLITE ]
        </button>
      </div>

      <div class="panel" style="flex: 0.8">
        <h2>// CORE ANALYTICS</h2>
        <div id="prob-val" class="big-stat">--%</div>
        <div class="sub-stat">COLLAPSE PROBABILITY</div>
        <div style="margin-top: 10px; border-top: 1px dashed #333"></div>
        <div
          id="stab-val"
          class="big-stat"
          style="font-size: 1.5rem; margin-top: 10px"
        >
          --
        </div>
        <div class="sub-stat">STABILITY INDEX</div>
      </div>

      <div class="panel" style="flex: 1.4">
        <h2>// LIVE EVENT LOG</h2>
        <div id="log-window">
          <div class="log-entry">SYSTEM READY. WAITING FOR CONNECTION...</div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // INIT MAP
      var map = L.map("map", { zoomControl: false }).setView([30, -100], 3); // Nhìn toàn cảnh Thái Bình Dương
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      ).addTo(map);

      var markersGroup = L.layerGroup().addTo(map); // Layer chứa các chấm động đất
      var liveInterval = null;
      var isLive = false;

      function updateUI(el) {
        el.previousElementSibling.firstElementChild.innerText = el.value;
      }

      function addLog(msg, type = "log-ok") {
        const win = document.getElementById("log-window");
        const time = new Date().toLocaleTimeString("en-US", { hour12: false });
        win.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span> <span class="${type}">${msg}</span></div>`;
        win.scrollTop = win.scrollHeight;
      }

      async function toggleLiveMode() {
        const btn = document.getElementById("btn-live");
        isLive = !isLive;

        if (isLive) {
          btn.classList.add("active-mode");
          btn.innerText = ">> SATELLITE LINK ACTIVE <<";
          addLog("ESTABLISHING LINK TO USGS SERVERS...", "log-ok");
          fetchRealData(); // Gọi ngay lập tức
          liveInterval = setInterval(fetchRealData, 10000); // Gọi lại mỗi 10s
        } else {
          btn.classList.remove("active-mode");
          btn.innerText = "[ CONNECT SATELLITE ]";
          clearInterval(liveInterval);
          addLog("LINK TERMINATED. MANUAL MODE.", "log-crit");
        }
      }

      async function fetchRealData() {
        try {
          addLog("SCANNING GLOBAL SEISMIC NETWORK...", "log-ok");
          const res = await fetch("/api/v1/disaster/realtime/usgs");
          const data = await res.json();

          if (data.upt_metrics) {
            // 1. Cập nhật Số liệu UPT
            const prob = (data.upt_metrics.probability_index * 100).toFixed(2);
            const probEl = document.getElementById("prob-val");
            probEl.innerText = prob + "%";
            document.getElementById("stab-val").innerText =
              data.upt_metrics.stability_score.toFixed(3);

            // Đổi màu cảnh báo
            if (data.upt_metrics.alert_level === "CRITICAL")
              probEl.style.color = "var(--neon-red)";
            else if (data.upt_metrics.alert_level === "WARNING")
              probEl.style.color = "var(--neon-yellow)";
            else probEl.style.color = "white";

            // 2. Vẽ Bản đồ (Quan trọng)
            markersGroup.clearLayers(); // Xóa điểm cũ

            data.raw_sensors.forEach((quake) => {
              // Tính bán kính dựa trên năng lượng (Mag)
              const radius = quake.energy_level * 500000;

              // Màu sắc dựa trên mức độ nguy hiểm
              let color = "#0f0";
              if (quake.energy_level > 0.6) color = "#f00";
              else if (quake.energy_level > 0.4) color = "#ff0";

              L.circle([quake.lat, quake.lon], {
                color: color,
                fillColor: color,
                fillOpacity: 0.3,
                radius: radius,
              })
                .addTo(markersGroup)
                .bindPopup(
                  `<b>${quake.place}</b><br>Energy: ${quake.energy_level}<br>Anomaly: ${quake.anomaly_score}`
                );

              addLog(
                `DETECTED: ${quake.place} (E=${quake.energy_level})`,
                "log-ok"
              );
            });
          }
        } catch (e) {
          addLog("CONNECTION LOST: " + e, "log-crit");
        }
      }
    </script>
  </body>
</html>
