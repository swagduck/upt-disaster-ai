<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT GLOBAL MONITOR // V7.0</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #00f3ff; /* Cyan */
        --danger: #ff003c; /* Red */
        --warn: #ffd700; /* Gold */
        --storm: #bd00ff; /* Purple */
        --fire: #ff6600; /* Orange */
        --bg: #020408;
        --border: 1px solid rgba(0, 243, 255, 0.3);
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--primary);
        font-family: "Share Tech Mono", monospace;
        overflow: hidden;
        height: 100vh;
      }

      /* LAYOUT */
      .grid-container {
        display: grid;
        grid-template-rows: 65vh 35vh;
        height: 100vh;
      }

      /* MAP */
      #map-wrapper {
        position: relative;
        border-bottom: 2px solid var(--primary);
      }
      #map {
        height: 100%;
        width: 100%;
        filter: grayscale(90%) contrast(1.2) invert(10%);
      }
      .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 400;
        background: linear-gradient(
            rgba(0, 243, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
      }

      /* INSPECTOR PANEL */
      #inspector {
        position: absolute;
        top: 0;
        right: -320px;
        width: 300px;
        height: 100%;
        background: rgba(0, 10, 20, 0.95);
        border-left: 2px solid var(--primary);
        z-index: 999;
        transition: 0.4s;
        padding: 20px;
        overflow-y: auto;
      }
      #inspector.active {
        right: 0;
      }
      .row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #333;
        padding: 8px 0;
      }
      .lbl {
        color: #888;
      }
      .val {
        font-weight: bold;
        color: #fff;
        text-align: right;
      }

      /* HUD */
      .hud {
        display: flex;
        gap: 10px;
        padding: 10px;
        background: rgba(0, 0, 0, 0.95);
        height: 100%;
        box-sizing: border-box;
      }
      .panel {
        border: var(--border);
        background: rgba(0, 20, 40, 0.5);
        padding: 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      h3 {
        margin: 0 0 10px 0;
        color: var(--primary);
        font-family: "Orbitron";
        font-size: 0.9rem;
        border-bottom: 1px dashed #333;
      }

      /* CONTROLS */
      input[type="range"] {
        appearance: none;
        -webkit-appearance: none;
        width: 100%;
        background: transparent;
        margin: 10px 0;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 14px;
        width: 6px;
        background: var(--primary);
        cursor: pointer;
        margin-top: -5px;
        border: 1px solid white;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 4px;
        background: #333;
      }

      .btn-link {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 12px;
        font-family: "Orbitron";
        cursor: pointer;
        margin-top: auto;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        transition: 0.2s;
      }
      .btn-link:hover {
        background: var(--primary);
        color: black;
        box-shadow: 0 0 15px var(--primary);
      }
      .btn-link.active {
        background: var(--danger);
        border-color: var(--danger);
        color: white;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(255, 0, 60, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 60, 0);
        }
      }

      /* LOGS */
      #log-box {
        font-size: 0.75rem;
        overflow-y: auto;
        font-family: "Courier New";
        flex: 1;
      }
      .log-item {
        margin-bottom: 3px;
        border-left: 2px solid #333;
        padding-left: 5px;
      }
      .log-crit {
        border-color: var(--danger);
        color: var(--danger);
      }
      .log-sys {
        border-color: var(--primary);
        color: #fff;
      }

      .big-stat {
        font-family: "Orbitron";
        font-size: 3rem;
        color: #fff;
        text-shadow: 0 0 15px var(--primary);
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <div id="map-wrapper">
        <div class="grid-overlay"></div>
        <div id="map"></div>

        <div id="inspector">
          <h2
            style="
              font-family: 'Orbitron';
              color: var(--primary);
              border-bottom: 2px solid var(--primary);
            "
          >
            EVENT ANALYSIS
          </h2>
          <div id="inspector-content">Select a target...</div>
          <button
            onclick="document.getElementById('inspector').classList.remove('active')"
            style="
              width: 100%;
              margin-top: 20px;
              padding: 10px;
              background: transparent;
              border: 1px solid #555;
              color: #888;
              cursor: pointer;
            "
          >
            CLOSE PANEL
          </button>
        </div>
      </div>

      <div class="hud">
        <div class="panel" style="flex: 1">
          <h3>// INPUT PARAMETERS</h3>
          <div style="margin-bottom: 10px">
            <div style="display: flex; justify-content: space-between">
              <span>ENERGY (E)</span> <span id="lbl-e">0.50</span>
            </div>
            <input
              type="range"
              id="in-e"
              min="0"
              max="1"
              step="0.01"
              value="0.5"
              oninput="uiUpdate(this)"
            />
          </div>
          <div style="margin-bottom: 10px">
            <div style="display: flex; justify-content: space-between">
              <span>ANOMALY (A)</span> <span id="lbl-a">0.50</span>
            </div>
            <input
              type="range"
              id="in-a"
              min="0"
              max="1"
              step="0.01"
              value="0.5"
              oninput="uiUpdate(this)"
            />
          </div>
          <button id="btn-link" class="btn-link" onclick="toggleSystem()">
            CONNECT SATELLITE
          </button>
        </div>

        <div class="panel" style="flex: 0.8; text-align: center">
          <h3>// PROBABILITY INDEX</h3>
          <div id="val-prob" class="big-stat">--%</div>
          <div
            id="val-status"
            style="
              margin-top: 10px;
              font-weight: bold;
              letter-spacing: 2px;
              color: #888;
            "
          >
            STANDBY
          </div>
        </div>

        <div class="panel" style="flex: 1.2">
          <h3>// GLOBAL EVENT LOG</h3>
          <div id="log-box">
            <div class="log-item">System V7.0 Initialized.</div>
            <div class="log-item">Waiting for uplink...</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // 1. SETUP MAP
      const map = L.map("map", {
        zoomControl: false,
        attributionControl: false,
      }).setView([20, 0], 2);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      ).addTo(map);

      let heatLayer = L.heatLayer([], {
        radius: 30,
        blur: 20,
        maxZoom: 10,
      }).addTo(map);
      let markersGroup = L.layerGroup().addTo(map);

      let isLive = false;
      let updateTimer = null;

      // 2. UI HELPERS
      function uiUpdate(el) {
        el.previousElementSibling.lastElementChild.innerText = parseFloat(
          el.value
        ).toFixed(2);
        if (!isLive) {
          // Manual Simulation logic
          let e = parseFloat(document.getElementById("in-e").value);
          let a = parseFloat(document.getElementById("in-a").value);
          document.getElementById("val-prob").innerText =
            (e * a * 100).toFixed(1) + "%";
        }
      }

      function log(msg, type = "log-sys") {
        const box = document.getElementById("log-box");
        const time = new Date().toLocaleTimeString("en-US", { hour12: false });
        box.innerHTML += `<div class="log-item ${type}">[${time}] ${msg}</div>`;
        box.scrollTop = box.scrollHeight;
      }

      function showInspector(data, icon) {
        const p = document.getElementById("inspector");
        p.classList.add("active");
        document.getElementById("inspector-content").innerHTML = `
                <div class="row"><span class="lbl">TYPE</span> <span class="val" style="color:var(--primary); font-size:1.2rem">${icon} ${
          data.type
        }</span></div>
                <div class="row"><span class="lbl">LOCATION</span> <span class="val">${
                  data.place
                }</span></div>
                <div class="row"><span class="lbl">ENERGY (E)</span> <span class="val" style="color:var(--warn)">${
                  data.energy_level
                }</span></div>
                <div class="row"><span class="lbl">ANOMALY (A)</span> <span class="val">${
                  data.anomaly_score
                }</span></div>
                <div class="row"><span class="lbl">COORDINATES</span> <span class="val">${data.lat.toFixed(
                  2
                )}, ${data.lon.toFixed(2)}</span></div>
                <div style="margin-top:20px; border:1px solid #444; padding:10px; text-align:center;">
                    STATUS: <strong style="color:${
                      data.energy_level > 0.6
                        ? "var(--danger)"
                        : "var(--primary)"
                    }">${
          data.energy_level > 0.6 ? "CRITICAL" : "STABLE"
        }</strong>
                </div>
            `;
      }

      // 3. SYSTEM LOGIC
      async function toggleSystem() {
        const btn = document.getElementById("btn-link");
        isLive = !isLive;

        if (isLive) {
          btn.classList.add("active");
          btn.innerText = "TERMINATE LINK";
          // Lock manual inputs
          document.getElementById("in-e").disabled = true;
          document.getElementById("in-a").disabled = true;

          log("Uplink established. Scanning...", "log-sys");
          fetchData();
          updateTimer = setInterval(fetchData, 10000); // 10s refresh
        } else {
          btn.classList.remove("active");
          btn.innerText = "CONNECT SATELLITE";
          document.getElementById("in-e").disabled = false;
          document.getElementById("in-a").disabled = false;
          clearInterval(updateTimer);
          log("Link terminated.", "log-crit");
        }
      }

      async function fetchData() {
        try {
          const res = await fetch("/api/v1/disaster/realtime/usgs");
          const data = await res.json();

          if (data.upt_metrics) {
            // Update Main Stats
            const prob = (data.upt_metrics.probability_index * 100).toFixed(1);
            const probEl = document.getElementById("val-prob");
            probEl.innerText = prob + "%";

            // Color Logic
            if (prob > 70) {
              probEl.style.color = "var(--danger)";
              probEl.style.textShadow = "0 0 20px red";
            } else if (prob > 40) {
              probEl.style.color = "var(--warn)";
              probEl.style.textShadow = "none";
            } else {
              probEl.style.color = "#fff";
              probEl.style.textShadow = "none";
            }

            document.getElementById("val-status").innerText =
              data.upt_metrics.alert_level;

            // Update Map
            renderMap(data.raw_sensors);
          }
        } catch (e) {
          log("Connection lost.", "log-crit");
        }
      }

      function renderMap(sensors) {
        markersGroup.clearLayers();
        let heatPoints = [];
        let maxE = 0,
          maxA = 0;

        sensors.forEach((s) => {
          if (s.energy_level > maxE) maxE = s.energy_level;
          if (s.anomaly_score > maxA) maxA = s.anomaly_score;

          // COLOR & ICON MAPPING
          let color = "#fff";
          let icon = "ðŸ“";
          let radius = s.energy_level * 20;

          if (s.type === "EARTHQUAKE") {
            color = s.energy_level > 0.6 ? "var(--danger)" : "var(--primary)";
            icon = "ðŸ“‰";
            heatPoints.push([s.lat, s.lon, s.energy_level]);
          } else if (s.type === "WILDFIRE") {
            color = "var(--fire)";
            icon = "ðŸ”¥";
            heatPoints.push([s.lat, s.lon, 0.8]);
          } else if (s.type === "VOLCANO") {
            color = "var(--warn)";
            icon = "ðŸŒ‹";
            radius = 30;
            heatPoints.push([s.lat, s.lon, 1.0]);
          } else if (s.type === "STORM") {
            color = "var(--storm)";
            icon = "ðŸŒ€";
            radius = 40;
          }

          // Draw Marker
          L.circleMarker([s.lat, s.lon], {
            radius: radius,
            color: color,
            fillColor: color,
            fillOpacity: 0.4,
            weight: 1,
          })
            .addTo(markersGroup)
            .on("click", () => showInspector(s, icon));
        });

        // Update Heatmap
        heatLayer.setLatLngs(heatPoints);

        // Auto-Pilot Sliders
        document.getElementById("in-e").value = maxE;
        document.getElementById("lbl-e").innerText = maxE.toFixed(2);
        document.getElementById("in-a").value = maxA;
        document.getElementById("lbl-a").innerText = maxA.toFixed(2);

        log(`Synced ${sensors.length} events. Max E: ${maxE}`, "log-sys");
      }
    </script>
  </body>
</html>
