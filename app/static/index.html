<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT COMMANDER // V8.0 DATA VIZ</title>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --primary: #00f3ff; /* Cyan */
        --danger: #ff003c; /* Red */
        --warn: #ffd700; /* Gold */
        --bg: #020408;
        --panel-bg: rgba(0, 20, 40, 0.6);
        --border: 1px solid rgba(0, 243, 255, 0.3);
      }

      body {
        margin: 0;
        background: var(--bg);
        color: var(--primary);
        font-family: "Share Tech Mono", monospace;
        overflow: hidden;
        height: 100vh;
      }

      /* --- LAYOUT GRID --- */
      .grid-container {
        display: grid;
        grid-template-rows: 55vh 45vh; /* Map 55%, Dashboard 45% */
        height: 100vh;
      }

      /* --- MAP AREA --- */
      #map-wrapper {
        position: relative;
        border-bottom: 2px solid var(--primary);
      }
      #map {
        height: 100%;
        width: 100%;
        filter: grayscale(90%) contrast(1.2) invert(10%);
      }
      .grid-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 400;
        background: linear-gradient(
            rgba(0, 243, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
        background-size: 40px 40px;
      }

      /* --- DASHBOARD HUD --- */
      .hud {
        display: flex;
        gap: 10px;
        padding: 10px;
        background: radial-gradient(circle at center, #0a1520 0%, #000 100%);
      }

      .panel {
        border: var(--border);
        background: var(--panel-bg);
        padding: 10px;
        display: flex;
        flex-direction: column;
        position: relative;
        backdrop-filter: blur(5px);
      }

      h3 {
        margin: 0 0 5px 0;
        color: var(--primary);
        font-family: "Orbitron";
        font-size: 0.8rem;
        border-bottom: 1px dashed #333;
        letter-spacing: 1px;
      }

      /* --- CHARTS --- */
      .chart-container {
        flex: 1;
        position: relative;
        width: 100%;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      /* --- LOGS --- */
      #log-box {
        font-size: 0.7rem;
        overflow-y: auto;
        font-family: "Courier New";
        flex: 1;
        margin-top: 5px;
      }
      .log-item {
        margin-bottom: 2px;
        border-left: 2px solid #333;
        padding-left: 5px;
      }
      .log-crit {
        border-color: var(--danger);
        color: var(--danger);
      }
      .log-sys {
        border-color: var(--primary);
        color: #ccc;
      }

      /* --- BUTTONS & CONTROLS --- */
      .btn-link {
        background: transparent;
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 8px;
        font-family: "Orbitron";
        cursor: pointer;
        margin-top: auto;
        text-transform: uppercase;
        font-weight: bold;
        transition: 0.2s;
        font-size: 0.9rem;
      }
      .btn-link.active {
        background: var(--danger);
        border-color: var(--danger);
        color: white;
        animation: pulse 1.5s infinite;
      }
      @keyframes pulse {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 0, 60, 0.7);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(255, 0, 60, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 0, 60, 0);
        }
      }

      /* --- INSPECTOR --- */
      #inspector {
        position: absolute;
        top: 0;
        right: -320px;
        width: 300px;
        height: 100%;
        background: rgba(0, 10, 20, 0.95);
        border-left: 2px solid var(--primary);
        z-index: 999;
        transition: 0.4s;
        padding: 20px;
        box-sizing: border-box;
      }
      #inspector.active {
        right: 0;
      }
      .row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid #333;
        padding: 8px 0;
      }
      .lbl {
        color: #888;
        font-size: 0.8rem;
      }
      .val {
        font-weight: bold;
        color: #fff;
        text-align: right;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <div class="grid-container">
      <div id="map-wrapper">
        <div class="grid-overlay"></div>
        <div id="map"></div>
        <div id="inspector">
          <h2
            style="
              font-family: 'Orbitron';
              color: var(--primary);
              border-bottom: 2px solid var(--primary);
            "
          >
            TARGET ANALYSIS
          </h2>
          <div id="inspector-content">Waiting for selection...</div>
          <button
            onclick="document.getElementById('inspector').classList.remove('active')"
            style="
              width: 100%;
              margin-top: 20px;
              padding: 10px;
              background: transparent;
              border: 1px solid #555;
              color: #888;
              cursor: pointer;
            "
          >
            CLOSE
          </button>
        </div>
      </div>

      <div class="hud">
        <div class="panel" style="flex: 0.8">
          <h3>// SYSTEM STATUS</h3>
          <div style="text-align: center; margin-top: 10px">
            <div
              id="val-prob"
              style="
                font-family: 'Orbitron';
                font-size: 2.5rem;
                color: #fff;
                text-shadow: 0 0 10px var(--primary);
              "
            >
              --%
            </div>
            <div style="font-size: 0.7rem; color: #888">
              COLLAPSE PROBABILITY
            </div>
          </div>

          <div
            style="
              margin-top: 15px;
              border-top: 1px dashed #333;
              padding-top: 10px;
            "
          >
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
                margin-bottom: 5px;
              "
            >
              <span>RESONANCE:</span>
              <span id="val-res" style="color: var(--warn)">0.00</span>
            </div>
            <div
              style="
                display: flex;
                justify-content: space-between;
                font-size: 0.8rem;
              "
            >
              <span>STABILITY:</span>
              <span id="val-stab" style="color: var(--primary)">1.00</span>
            </div>
          </div>

          <button id="btn-link" class="btn-link" onclick="toggleSystem()">
            CONNECT SATELLITE
          </button>
        </div>

        <div class="panel" style="flex: 1.5">
          <h3>// UPT RESONANCE WAVE [R(t)]</h3>
          <div class="chart-container">
            <canvas id="waveChart"></canvas>
          </div>
        </div>

        <div class="panel" style="flex: 1">
          <h3>// THREAT DISTRIBUTION</h3>
          <div class="chart-container">
            <canvas id="radarChart"></canvas>
          </div>
        </div>

        <div class="panel" style="flex: 1">
          <h3>// LIVE FEED</h3>
          <div id="log-box">
            <div class="log-item">System V8.0 Loaded.</div>
            <div class="log-item">Charts initialized.</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // --- 1. SETUP MAP ---
      const map = L.map("map", {
        zoomControl: false,
        attributionControl: false,
      }).setView([20, 0], 2);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      ).addTo(map);
      let heatLayer = L.heatLayer([], { radius: 35, blur: 20 }).addTo(map);
      let markersGroup = L.layerGroup().addTo(map);

      // --- 2. SETUP CHARTS (Chart.js) ---

      // Chart 1: Line Chart (S√≥ng dao ƒë·ªông)
      const ctxWave = document.getElementById("waveChart").getContext("2d");
      const waveChart = new Chart(ctxWave, {
        type: "line",
        data: {
          labels: Array(20).fill(""), // Placeholder cho 20 ƒëi·ªÉm d·ªØ li·ªáu
          datasets: [
            {
              label: "Resonance",
              data: Array(20).fill(0),
              borderColor: "#00f3ff",
              backgroundColor: "rgba(0, 243, 255, 0.1)",
              borderWidth: 2,
              tension: 0.4, // L√†m m·ªÅm ƒë∆∞·ªùng cong
              pointRadius: 0,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false }, // ·∫®n tr·ª•c X
            y: {
              display: true,
              grid: { color: "#333" },
              ticks: { color: "#888", font: { family: "Share Tech Mono" } },
              min: 0,
              max: 1.0,
            },
          },
          animation: { duration: 0 }, // T·∫Øt animation m∆∞·ª£t ƒë·ªÉ t·∫°o c·∫£m gi√°c realtime gi·∫≠t c·ª•c
        },
      });

      // Chart 2: Radar Chart (Ph√¢n b·ªë m·ªëi nguy)
      const ctxRadar = document.getElementById("radarChart").getContext("2d");
      const radarChart = new Chart(ctxRadar, {
        type: "polarArea", // D·∫°ng bi·ªÉu ƒë·ªì c·ª±c (tr√¥ng nh∆∞ radar)
        data: {
          labels: ["Quake", "Volcano", "Storm", "Fire"],
          datasets: [
            {
              data: [0, 0, 0, 0],
              backgroundColor: [
                "rgba(0, 243, 255, 0.5)", // Cyan
                "rgba(255, 215, 0, 0.5)", // Gold
                "rgba(189, 0, 255, 0.5)", // Purple
                "rgba(255, 102, 0, 0.5)", // Orange
              ],
              borderWidth: 1,
              borderColor: "#000",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "right",
              labels: {
                color: "#fff",
                font: { family: "Share Tech Mono", size: 10 },
              },
            },
          },
          scales: {
            r: {
              grid: { color: "#444" },
              ticks: { display: false, backdropColor: "transparent" },
              angleLines: { color: "#444" },
            },
          },
        },
      });

      // --- 3. LOGIC H·ªÜ TH·ªêNG ---
      let isLive = false;
      let updateTimer = null;

      function log(msg, type = "log-sys") {
        const box = document.getElementById("log-box");
        const time = new Date().toLocaleTimeString("en-US", { hour12: false });
        box.innerHTML =
          `<div class="log-item ${type}">[${time}] ${msg}</div>` +
          box.innerHTML;
      }

      async function toggleSystem() {
        const btn = document.getElementById("btn-link");
        isLive = !isLive;
        if (isLive) {
          btn.classList.add("active");
          btn.innerText = "ABORT LINK";
          log("Satellite Uplink Established.", "log-sys");
          fetchData();
          updateTimer = setInterval(fetchData, 8000); // 8s update
        } else {
          btn.classList.remove("active");
          btn.innerText = "CONNECT SATELLITE";
          clearInterval(updateTimer);
          log("Connection Terminated.", "log-crit");
        }
      }

      async function fetchData() {
        try {
          const res = await fetch("/api/v1/disaster/realtime/usgs");
          const data = await res.json();

          if (data.upt_metrics) {
            updateDashboard(data);
            renderMap(data.raw_sensors);
          }
        } catch (e) {
          console.error(e);
        }
      }

      function updateDashboard(data) {
        // 1. Text Metrics
        const prob = (data.upt_metrics.probability_index * 100).toFixed(1);
        const probEl = document.getElementById("val-prob");
        probEl.innerText = prob + "%";

        // ƒê·ªïi m√†u c·∫£nh b√°o
        if (prob > 70) {
          probEl.style.color = "var(--danger)";
          probEl.style.textShadow = "0 0 20px red";
        } else if (prob > 40) {
          probEl.style.color = "var(--warn)";
          probEl.style.textShadow = "none";
        } else {
          probEl.style.color = "#fff";
          probEl.style.textShadow = "0 0 10px var(--primary)";
        }

        document.getElementById("val-res").innerText =
          data.upt_metrics.network_resonance.toFixed(3);
        document.getElementById("val-stab").innerText =
          data.upt_metrics.stability_score.toFixed(3);

        // 2. Update Wave Chart (ƒê·∫©y d·ªØ li·ªáu m·ªõi v√†o, x√≥a d·ªØ li·ªáu c≈©)
        const newResonance = data.upt_metrics.network_resonance;
        waveChart.data.datasets[0].data.push(newResonance); // Th√™m v√†o cu·ªëi
        waveChart.data.datasets[0].data.shift(); // X√≥a ƒë·∫ßu
        waveChart.update();

        // 3. Update Radar Chart (ƒê·∫øm s·ªë l∆∞·ª£ng s·ª± ki·ªán)
        let counts = { EARTHQUAKE: 0, VOLCANO: 0, STORM: 0, WILDFIRE: 0 };
        data.raw_sensors.forEach((s) => {
          if (counts[s.type] !== undefined) counts[s.type]++;
        });
        radarChart.data.datasets[0].data = [
          counts["EARTHQUAKE"],
          counts["VOLCANO"],
          counts["STORM"],
          counts["WILDFIRE"],
        ];
        radarChart.update();
      }

      function renderMap(sensors) {
        markersGroup.clearLayers();
        let heatPoints = [];

        sensors.forEach((s) => {
          let color = "#00f3ff";
          let radius = s.energy_level * 15;
          let icon = "üìç";

          if (s.type === "EARTHQUAKE") {
            color = s.energy_level > 0.6 ? "#ff003c" : "#00f3ff";
            icon = "üìâ";
            heatPoints.push([s.lat, s.lon, s.energy_level]);
          } else if (s.type === "WILDFIRE") {
            color = "#ff6600";
            icon = "üî•";
            heatPoints.push([s.lat, s.lon, 0.8]);
          } else if (s.type === "VOLCANO") {
            color = "#ffd700";
            icon = "üåã";
            radius = 25;
            heatPoints.push([s.lat, s.lon, 1]);
          } else if (s.type === "STORM") {
            color = "#bd00ff";
            icon = "üåÄ";
            radius = 30;
          }

          L.circleMarker([s.lat, s.lon], {
            radius: radius,
            color: color,
            fillColor: color,
            fillOpacity: 0.4,
            weight: 1,
          })
            .addTo(markersGroup)
            .on("click", () => showInspector(s, icon));
        });
        heatLayer.setLatLngs(heatPoints);
        log(`Synced: ${sensors.length} objects active.`, "log-sys");
      }

      function showInspector(data, icon) {
        const p = document.getElementById("inspector");
        p.classList.add("active");
        document.getElementById("inspector-content").innerHTML = `
                <div class="row"><span class="lbl">TYPE</span> <span class="val" style="color:var(--primary); font-size:1.1rem">${icon} ${
          data.type
        }</span></div>
                <div class="row"><span class="lbl">LOCATION</span> <span class="val">${data.place.substring(
                  0,
                  25
                )}</span></div>
                <div class="row"><span class="lbl">ENERGY INDEX</span> <span class="val" style="color:var(--warn)">${data.energy_level.toFixed(
                  3
                )}</span></div>
                <div class="row"><span class="lbl">ANOMALY</span> <span class="val">${data.anomaly_score.toFixed(
                  3
                )}</span></div>
                <div style="margin-top:15px; border:1px solid #333; padding:10px; text-align:center;">
                    <div style="font-size:0.7rem; color:#888;">UPT PREDICTION</div>
                    <strong style="color:${
                      data.energy_level > 0.6
                        ? "var(--danger)"
                        : "var(--primary)"
                    }; font-size:1.2rem;">
                        ${data.energy_level > 0.6 ? "CRITICAL" : "STABLE"}
                    </strong>
                </div>
            `;
      }
    </script>
  </body>
</html>
