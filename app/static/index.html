<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT QUANTUM CORE // LIVE COMMAND</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --neon-green: #0f0;
        --neon-red: #f00;
        --neon-blue: #0ff;
        --neon-yellow: #ff0;
        --bg-color: #050a10;
        --glass: rgba(10, 20, 30, 0.9);
      }

      body {
        margin: 0;
        padding: 0;
        background-color: var(--bg-color);
        background-image: linear-gradient(
            rgba(0, 255, 255, 0.03) 1px,
            transparent 1px
          ),
          linear-gradient(90deg, rgba(0, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 30px 30px;
        color: var(--neon-green);
        font-family: "Share Tech Mono", monospace;
        overflow: hidden;
        height: 100vh;
      }

      /* --- MAP SECTION --- */
      #map-container {
        position: relative;
        height: 60vh;
        border-bottom: 2px solid var(--neon-blue);
        box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
      }
      #map {
        height: 100%;
        width: 100%;
        filter: grayscale(85%) contrast(1.2) invert(10%);
      }

      .scan-line {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 5px;
        background: rgba(0, 255, 255, 0.8);
        box-shadow: 0 0 15px var(--neon-blue);
        z-index: 999;
        animation: scan 4s infinite linear;
        pointer-events: none;
      }
      @keyframes scan {
        0% {
          top: 0%;
          opacity: 0;
        }
        50% {
          opacity: 1;
        }
        100% {
          top: 100%;
          opacity: 0;
        }
      }

      /* --- HUD CONTROL SECTION --- */
      .hud-container {
        display: flex;
        height: 40vh;
        padding: 10px;
        gap: 10px;
        box-sizing: border-box;
      }
      .panel {
        border: 1px solid var(--neon-blue);
        background: var(--glass);
        padding: 15px;
        flex: 1;
        display: flex;
        flex-direction: column;
        position: relative;
        box-shadow: inset 0 0 20px rgba(0, 255, 255, 0.05);
      }
      h2 {
        margin: 0 0 10px 0;
        color: var(--neon-blue);
        font-family: "Orbitron";
        font-size: 1rem;
        border-bottom: 1px dashed #333;
        padding-bottom: 5px;
      }

      /* --- SLIDERS (Custom Style) --- */
      .control-group {
        margin-bottom: 12px;
      }
      label {
        display: flex;
        justify-content: space-between;
        font-size: 0.85rem;
        margin-bottom: 4px;
        color: #aaa;
      }
      .val-display {
        color: #fff;
        font-weight: bold;
      }

      input[type="range"] {
        appearance: none;
        -webkit-appearance: none; /* Fix lỗi vàng trong VS Code */
        width: 100%;
        background: transparent;
      }
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 12px;
        width: 12px;
        background: var(--neon-blue);
        cursor: pointer;
        margin-top: -5px;
        box-shadow: 0 0 8px var(--neon-blue);
        border-radius: 50%;
      }
      input[type="range"]::-webkit-slider-runnable-track {
        width: 100%;
        height: 2px;
        background: #333;
      }

      /* --- METRICS & LOGS --- */
      #log-window {
        flex: 1;
        font-size: 0.75rem;
        overflow-y: auto;
        border: 1px solid #333;
        padding: 8px;
        background: #000;
        font-family: "Courier New";
        scroll-behavior: smooth;
      }
      .log-entry {
        margin-bottom: 3px;
        border-bottom: 1px solid #111;
        padding-bottom: 2px;
      }
      .log-time {
        color: #666;
        margin-right: 5px;
      }
      .log-crit {
        color: var(--neon-red);
        text-shadow: 0 0 5px red;
      }
      .log-warn {
        color: var(--neon-yellow);
      }
      .log-ok {
        color: var(--neon-green);
      }

      .big-stat {
        font-family: "Orbitron";
        font-size: 3rem;
        color: white;
        text-align: center;
        text-shadow: 0 0 10px currentColor;
      }
      .sub-stat {
        text-align: center;
        font-size: 0.8rem;
        color: #888;
        letter-spacing: 2px;
      }

      /* --- BUTTONS --- */
      .btn-live {
        background: rgba(0, 255, 0, 0.1);
        border: 1px solid var(--neon-green);
        color: var(--neon-green);
        padding: 12px;
        font-family: "Orbitron";
        cursor: pointer;
        margin-top: auto;
        font-weight: bold;
        transition: 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .btn-live:hover {
        background: var(--neon-green);
        color: black;
        box-shadow: 0 0 20px var(--neon-green);
      }

      .active-mode {
        background: var(--neon-green) !important;
        color: black !important;
        box-shadow: 0 0 15px var(--neon-green) !important;
        animation: pulse-btn 2s infinite;
      }
      @keyframes pulse-btn {
        0% {
          box-shadow: 0 0 5px var(--neon-green);
        }
        50% {
          box-shadow: 0 0 20px var(--neon-green);
        }
        100% {
          box-shadow: 0 0 5px var(--neon-green);
        }
      }
    </style>
  </head>
  <body>
    <div id="map-container">
      <div class="scan-line"></div>
      <div id="map"></div>
    </div>

    <div class="hud-container">
      <div class="panel" style="flex: 0.9">
        <h2>// PARAMETERS</h2>

        <div class="control-group">
          <label
            >ENERGY (Magnitude/10)
            <span id="val-energy" class="val-display">0.50</span></label
          >
          <input
            type="range"
            id="in-energy"
            min="0"
            max="1"
            step="0.01"
            value="0.5"
            oninput="manualUpdate(this)"
          />
        </div>

        <div class="control-group">
          <label
            >ANOMALY (Significance)
            <span id="val-anomaly" class="val-display">0.50</span></label
          >
          <input
            type="range"
            id="in-anomaly"
            min="0"
            max="1"
            step="0.01"
            value="0.5"
            oninput="manualUpdate(this)"
          />
        </div>

        <div class="control-group">
          <label
            >GEO_WEAKNESS (Manual)
            <span id="val-geo" class="val-display">0.50</span></label
          >
          <input
            type="range"
            id="in-geo"
            min="0"
            max="1"
            step="0.01"
            value="0.5"
            oninput="manualUpdate(this)"
          />
        </div>

        <button id="btn-live" class="btn-live" onclick="toggleLiveMode()">
          [ CONNECT SATELLITE ]
        </button>
      </div>

      <div class="panel" style="flex: 0.8">
        <h2>// CORE ANALYTICS</h2>
        <div id="prob-val" class="big-stat">--%</div>
        <div class="sub-stat">COLLAPSE PROBABILITY</div>

        <div
          style="
            margin-top: 20px;
            border-top: 1px dashed #333;
            padding-top: 10px;
          "
        >
          <div
            id="stab-val"
            style="
              font-size: 2rem;
              font-weight: bold;
              text-align: center;
              color: var(--neon-blue);
            "
          >
            --
          </div>
          <div class="sub-stat">STABILITY INDEX</div>
        </div>
      </div>

      <div class="panel" style="flex: 1.3">
        <h2>// LIVE EVENT LOG</h2>
        <div id="log-window">
          <div class="log-entry">
            <span class="log-time">--:--:--</span> SYSTEM INITIALIZED.
          </div>
          <div class="log-entry">
            <span class="log-time">--:--:--</span> WAITING FOR DATA STREAM...
          </div>
        </div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // 1. SETUP MAP
      var map = L.map("map", {
        zoomControl: false,
        attributionControl: false,
      }).setView([20, 0], 2);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      ).addTo(map);
      var markersGroup = L.layerGroup().addTo(map);

      // 2. VARIABLES
      var liveInterval = null;
      var isLive = false;

      // 3. HELPER FUNCTIONS
      function manualUpdate(el) {
        // Update số hiển thị
        el.previousElementSibling.firstElementChild.innerText = parseFloat(
          el.value
        ).toFixed(2);
        // Nếu không phải Live mode thì cho phép người dùng tự mô phỏng kết quả
        if (!isLive) simulateCalculation();
      }

      function updateSliderUI(id, val) {
        const input = document.getElementById(id);
        input.value = val;
        input.previousElementSibling.firstElementChild.innerText =
          val.toFixed(2);
      }

      function addLog(msg, type = "log-ok") {
        const win = document.getElementById("log-window");
        const time = new Date().toLocaleTimeString("en-US", { hour12: false });
        win.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span> <span class="${type}">${msg}</span></div>`;
        win.scrollTop = win.scrollHeight;
      }

      // 4. MAIN LOGIC
      async function toggleLiveMode() {
        const btn = document.getElementById("btn-live");
        isLive = !isLive;

        if (isLive) {
          // BẬT CHẾ ĐỘ VỆ TINH
          btn.classList.add("active-mode");
          btn.innerText = ">> SATELLITE LINK ACTIVE <<";

          // Khóa input manual để tránh xung đột (visual only)
          document.getElementById("in-energy").style.opacity = "0.5";
          document.getElementById("in-anomaly").style.opacity = "0.5";

          addLog("ESTABLISHING SECURE CONNECTION...", "log-warn");
          fetchRealData();
          liveInterval = setInterval(fetchRealData, 10000); // 10s quét 1 lần
        } else {
          // TẮT CHẾ ĐỘ VỆ TINH
          btn.classList.remove("active-mode");
          btn.innerText = "[ CONNECT SATELLITE ]";

          // Mở lại input
          document.getElementById("in-energy").style.opacity = "1";
          document.getElementById("in-anomaly").style.opacity = "1";

          clearInterval(liveInterval);
          addLog("LINK TERMINATED. RETURN TO MANUAL.", "log-crit");
        }
      }

      // Gọi API Backend lấy dữ liệu thật
      async function fetchRealData() {
        try {
          addLog("SCANNING GLOBAL SEISMIC NETWORK...", "log-ok");
          const res = await fetch("/api/v1/disaster/realtime/usgs");
          const data = await res.json();

          if (data.upt_metrics) {
            // A. CẬP NHẬT METRICS
            const prob = (data.upt_metrics.probability_index * 100).toFixed(1);
            const probEl = document.getElementById("prob-val");
            probEl.innerText = prob + "%";
            document.getElementById("stab-val").innerText =
              data.upt_metrics.stability_score.toFixed(3);

            // Màu sắc cảnh báo
            if (data.upt_metrics.alert_level === "CRITICAL") {
              probEl.style.color = "var(--neon-red)";
              probEl.style.textShadow = "0 0 20px red";
            } else if (data.upt_metrics.alert_level === "WARNING") {
              probEl.style.color = "var(--neon-yellow)";
              probEl.style.textShadow = "none";
            } else {
              probEl.style.color = "white";
              probEl.style.textShadow = "none";
            }

            // B. TỰ ĐỘNG CẬP NHẬT THANH TRƯỢT (AUTO-PILOT)
            // Tìm giá trị lớn nhất trong đám dữ liệu lấy về để hiển thị
            let maxEnergy = 0;
            let maxAnomaly = 0;

            if (data.raw_sensors && data.raw_sensors.length > 0) {
              data.raw_sensors.forEach((s) => {
                if (s.energy_level > maxEnergy) maxEnergy = s.energy_level;
                if (s.anomaly_score > maxAnomaly) maxAnomaly = s.anomaly_score;
              });

              // Cập nhật thanh trượt tự động
              updateSliderUI("in-energy", maxEnergy);
              updateSliderUI("in-anomaly", maxAnomaly);

              addLog(
                `AUTO-SYNC: E=${maxEnergy.toFixed(2)} | A=${maxAnomaly.toFixed(
                  2
                )}`,
                "log-warn"
              );
            }

            // C. VẼ BẢN ĐỒ
            markersGroup.clearLayers();
            data.raw_sensors.forEach((quake) => {
              let color = "#0f0";
              let radius = quake.energy_level * 300000; // Radius theo năng lượng

              if (quake.energy_level > 0.6) {
                color = "#f00";
                radius *= 1.5;
              } else if (quake.energy_level > 0.4) {
                color = "#ff0";
              }

              L.circle([quake.lat, quake.lon], {
                color: color,
                fillColor: color,
                fillOpacity: 0.4,
                radius: radius,
              })
                .addTo(markersGroup)
                .bindPopup(
                  `<strong style="color:black">${quake.place}</strong><br><span style="color:black">E: ${quake.energy_level} | A: ${quake.anomaly_score}</span>`
                );

              // Log sự kiện lớn
              if (quake.energy_level > 0.4) {
                addLog(
                  `DETECTED: ${quake.place.substring(0, 20)}...`,
                  "log-crit"
                );
              }
            });
          }
        } catch (e) {
          addLog("CONNECTION LOST / OFFLINE MODE", "log-crit");
          console.error(e);
        }
      }

      // Hàm giả lập cho chế độ Manual (để khi kéo tay vẫn thấy số nhảy)
      async function simulateCalculation() {
        // Logic đơn giản để hiện số cho vui mắt khi manual
        let e = parseFloat(document.getElementById("in-energy").value);
        let a = parseFloat(document.getElementById("in-anomaly").value);
        let c = parseFloat(document.getElementById("in-geo").value);

        let p = a * e * c; // Công thức UPT gốc
        let prob = (p * 100).toFixed(1);

        document.getElementById("prob-val").innerText = prob + "%";

        // Màu sắc
        const probEl = document.getElementById("prob-val");
        if (p > 0.7) probEl.style.color = "var(--neon-red)";
        else if (p > 0.4) probEl.style.color = "var(--neon-yellow)";
        else probEl.style.color = "white";
      }
    </script>
  </body>
</html>
