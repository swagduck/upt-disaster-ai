<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>UPT Disaster Monitor v2</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
        background: #0f172a;
        color: #00ff00;
        font-family: "Courier New", Courier, monospace;
      }
      #map {
        height: 60vh;
        width: 100%;
        border-bottom: 2px solid #00ff00;
      }
      .dashboard {
        padding: 20px;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
      }
      .card {
        background: #1e293b;
        border: 1px solid #334155;
        padding: 15px;
        flex: 1;
        border-radius: 8px;
        min-width: 250px;
      }
      h2 {
        margin-top: 0;
        color: #38bdf8;
        font-size: 1.1rem;
      }
      .metric {
        font-size: 2rem;
        font-weight: bold;
        color: #fff;
      }
      .btn-scan {
        background: #ef4444;
        color: white;
        border: none;
        padding: 15px;
        width: 100%;
        font-size: 1.2rem;
        cursor: pointer;
        text-transform: uppercase;
        font-weight: bold;
      }
      .slider-container {
        margin: 15px 0;
      }
      label {
        display: block;
        margin-bottom: 5px;
        color: #94a3b8;
      }
      input[type="range"] {
        width: 100%;
      }
      .val-display {
        float: right;
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div class="dashboard">
      <div class="card" style="border-color: #f59e0b">
        <h2>üéõÔ∏è B·∫£ng ƒêi·ªÅu Khi·ªÉn UPT</h2>

        <div class="slider-container">
          <label
            >NƒÉng l∆∞·ª£ng T√≠ch l≈©y (E)
            <span id="val-energy" class="val-display">0.5</span></label
          >
          <input
            type="range"
            id="in-energy"
            min="0"
            max="1"
            step="0.05"
            value="0.5"
            oninput="updateVal('energy', this.value)"
          />
        </div>

        <div class="slider-container">
          <label
            >B·∫•t th∆∞·ªùng C·∫£m bi·∫øn (A)
            <span id="val-anomaly" class="val-display">0.5</span></label
          >
          <input
            type="range"
            id="in-anomaly"
            min="0"
            max="1"
            step="0.05"
            value="0.5"
            oninput="updateVal('anomaly', this.value)"
          />
        </div>

        <div class="slider-container">
          <label
            >ƒê·ªô y·∫øu ƒê·ªãa ch·∫•t (C_geo)
            <span id="val-geo" class="val-display">0.5</span></label
          >
          <input
            type="range"
            id="in-geo"
            min="0"
            max="1"
            step="0.05"
            value="0.5"
            oninput="updateVal('geo', this.value)"
          />
        </div>

        <button class="btn-scan" onclick="scanDisaster()">CH·∫†Y M√î PH·ªéNG</button>
      </div>

      <div class="card">
        <h2>X√°c Su·∫•t S·ª•p ƒê·ªï (P)</h2>
        <div id="prob-val" class="metric">--</div>
        <div style="margin-top: 10px; font-size: 0.8em; color: gray">
          C√¥ng th·ª©c: P = A * E * C
        </div>
      </div>

      <div class="card">
        <h2>ƒê·ªô ·ªîn ƒê·ªãnh (Stability)</h2>
        <div id="stab-val" class="metric">--</div>
        <div id="status-text" style="color: yellow">S·∫µn s√†ng</div>
      </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      var map = L.map("map").setView([16.047, 108.206], 5);
      L.tileLayer(
        "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png"
      ).addTo(map);
      var currentCircle = null;

      function updateVal(id, val) {
        document.getElementById("val-" + id).innerText = val;
      }

      async function scanDisaster() {
        // 1. L·∫•y gi√° tr·ªã t·ª´ thanh tr∆∞·ª£t
        let energy = parseFloat(document.getElementById("in-energy").value);
        let anomaly = parseFloat(document.getElementById("in-anomaly").value);
        let geo = parseFloat(document.getElementById("in-geo").value);

        document.getElementById("status-text").innerText = "ƒêang t√≠nh to√°n...";

        // 2. T·∫°o payload ƒë·ªông
        const payload = {
          region_name: "Khu v·ª±c M√¥ ph·ªèng",
          sensors: [
            {
              station_id: "S1",
              energy_level: energy,
              anomaly_score: anomaly,
              location_weight: 1.0,
            },
          ],
          geo_vulnerability: geo,
          environmental_noise: 0.1,
          active_dampening: 0.0,
        };

        // 3. G·ªçi API
        try {
          const res = await fetch("/api/v1/disaster/predict", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });
          const data = await res.json();

          // 4. Hi·ªÉn th·ªã s·ªë li·ªáu
          document.getElementById("prob-val").innerText =
            (data.probability_index * 100).toFixed(0) + "%";
          document.getElementById("stab-val").innerText =
            data.stability_score.toFixed(2);
          document.getElementById("status-text").innerText = data.alert_level;

          // 5. X·ª≠ l√Ω V√≤ng tr√≤n ƒë·ªè tr√™n b·∫£n ƒë·ªì
          if (currentCircle) map.removeLayer(currentCircle); // X√≥a v√≤ng c≈©

          if (data.alert_level === "CRITICAL") {
            // N·∫øu Nguy hi·ªÉm: V·∫Ω v√≤ng ƒë·ªè to
            currentCircle = L.circle([16.047, 108.206], {
              color: "red",
              fillColor: "#f03",
              fillOpacity: 0.5,
              radius: 400000,
            }).addTo(map);
          } else if (data.alert_level === "WARNING") {
            // N·∫øu C·∫£nh b√°o: V·∫Ω v√≤ng v√†ng nh·ªè
            currentCircle = L.circle([16.047, 108.206], {
              color: "yellow",
              fillColor: "#fc3",
              fillOpacity: 0.5,
              radius: 200000,
            }).addTo(map);
          }
          // N·∫øu Normal th√¨ kh√¥ng v·∫Ω g√¨ c·∫£
        } catch (e) {
          alert("L·ªói: " + e);
        }
      }
    </script>
  </body>
</html>
