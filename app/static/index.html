<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>UPT COMMANDER V18.0 (REAL-TIME DATA)</title>

    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üì°</text></svg>"
    />

    <script src="//unpkg.com/three@0.124.0/build/three.min.js"></script>
    <script src="//unpkg.com/globe.gl@2.26.4/dist/globe.gl.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;700&family=VT323&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --neon-blue: #00f3ff;
        --neon-red: #ff003c;
        --neon-gold: #ffd700;
        --neon-green: #00ff66;
        --glass-bg: rgba(8, 15, 25, 0.85);
        --glass-border: rgba(0, 243, 255, 0.3);
        --tech-font: "Orbitron", sans-serif;
        --data-font: "Rajdhani", sans-serif;
        --code-font: "VT323", monospace;
        --defcon-1: #ff0000;
        --defcon-2: #ff4400;
        --defcon-3: #ffcc00;
        --defcon-4: #00ff66;
        --defcon-5: #0088ff;
      }

      body {
        margin: 0;
        background-color: #000;
        color: var(--neon-blue);
        font-family: var(--data-font);
        overflow: hidden;
        height: 100vh;
        user-select: none;
        transition: box-shadow 1s ease;
      }
      body.alert-mode {
        box-shadow: inset 0 0 100px rgba(255, 0, 0, 0.3);
      }

      .scanlines {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        background: linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0) 50%,
          rgba(0, 0, 0, 0.1) 50%,
          rgba(0, 0, 0, 0.1)
        );
        background-size: 100% 4px;
        opacity: 0.1;
      }

      #globe-viz {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 0;
      }

      /* DEFCON BAR */
      #defcon-bar {
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 400px;
        height: 60px;
        z-index: 20;
        background: rgba(0, 0, 0, 0.8);
        border: 2px solid var(--neon-blue);
        border-top: none;
        clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
        transition: 0.5s;
      }
      #defcon-level {
        font-family: var(--tech-font);
        font-size: 2rem;
        font-weight: 900;
        letter-spacing: 5px;
        color: var(--defcon-5);
        text-shadow: 0 0 15px currentColor;
      }

      /* TERMINAL */
      #terminal {
        position: absolute;
        top: 100px;
        left: 20px;
        width: 350px;
        height: 40vh;
        background: rgba(0, 10, 10, 0.9);
        border: 1px solid #333;
        border-left: 3px solid var(--neon-green);
        font-family: var(--code-font);
        font-size: 1.1rem;
        color: var(--neon-green);
        display: flex;
        flex-direction: column;
        z-index: 20;
        box-shadow: 0 0 15px rgba(0, 255, 100, 0.1);
        backdrop-filter: blur(5px);
      }
      #term-output {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        scrollbar-width: none;
      }
      .term-line {
        margin-bottom: 2px;
      }
      .term-line.sys {
        color: #888;
      }
      .term-line.err {
        color: var(--neon-red);
      }
      .term-line.cmd {
        color: #fff;
      }
      .term-line.voice {
        color: var(--neon-gold);
        font-style: italic;
      }
      #term-input-line {
        display: flex;
        border-top: 1px solid #333;
        padding: 5px;
        background: rgba(0, 255, 100, 0.05);
      }
      #term-input {
        background: transparent;
        border: none;
        color: #fff;
        font-family: var(--code-font);
        font-size: 1.1rem;
        flex: 1;
        outline: none;
        margin-left: 5px;
        text-transform: lowercase;
      }
      #mic-btn {
        background: transparent;
        border: none;
        color: #888;
        cursor: pointer;
        font-size: 1.2rem;
        transition: 0.3s;
        margin-right: 5px;
      }
      #mic-btn:hover {
        color: #fff;
      }
      #mic-btn.listening {
        color: var(--neon-red);
        animation: pulseRed 1s infinite;
      }

      /* INSPECTOR */
      #inspector {
        position: absolute;
        top: 20px;
        right: -400px;
        width: 350px;
        background: rgba(5, 10, 15, 0.95);
        border: 1px solid var(--neon-blue);
        border-left: 4px solid var(--neon-blue);
        padding: 20px;
        z-index: 20;
        transition: 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        clip-path: polygon(20px 0, 100% 0, 100% 100%, 0 100%, 0 20px);
        box-shadow: -10px 10px 30px rgba(0, 0, 0, 0.8);
      }
      #inspector.active {
        right: 20px;
      }
      .insp-row {
        display: flex;
        justify-content: space-between;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding: 6px 0;
        font-size: 0.9rem;
      }
      .insp-lbl {
        color: #888;
        font-size: 0.75rem;
        letter-spacing: 1px;
      }
      .insp-val {
        color: #fff;
        font-weight: 700;
        text-align: right;
      }
      .insp-code {
        font-family: var(--code-font);
        color: var(--neon-gold);
        font-size: 1rem;
      }
      .status-box {
        margin-top: 10px;
        padding: 8px;
        text-align: center;
        font-weight: bold;
        letter-spacing: 1px;
        background: rgba(255, 255, 255, 0.05);
        font-size: 0.9rem;
      }

      /* HUD */
      .hud-overlay {
        position: absolute;
        bottom: 15px;
        left: 15px;
        right: 15px;
        height: 28vh;
        display: grid;
        grid-template-columns: 0.8fr 1.5fr 1fr 1fr;
        gap: 10px;
        z-index: 10;
        pointer-events: none;
      }
      .panel {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        border: 1px solid var(--glass-border);
        padding: 12px;
        display: flex;
        flex-direction: column;
        pointer-events: auto;
        clip-path: polygon(0 0, 100% 0, 100% 85%, 92% 100%, 0 100%);
        transition: 0.3s;
        min-height: 0;
      }
      .panel:hover {
        border-color: rgba(0, 243, 255, 0.8);
        box-shadow: 0 0 30px rgba(0, 243, 255, 0.2);
      }
      h3 {
        margin: 0 0 8px 0;
        font-family: var(--tech-font);
        font-size: 0.7rem;
        letter-spacing: 1px;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        white-space: nowrap;
      }
      .big-stat {
        font-family: var(--tech-font);
        font-size: 2.5rem;
        font-weight: 700;
        color: #fff;
        text-shadow: 0 0 20px var(--neon-blue);
        line-height: 1;
      }
      .sub-stat {
        font-size: 0.7rem;
        color: #888;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin-top: 5px;
      }
      .btn-link {
        background: rgba(0, 243, 255, 0.1);
        border: 1px solid var(--neon-blue);
        color: var(--neon-blue);
        padding: 10px;
        font-size: 0.9rem;
        font-family: var(--tech-font);
        font-weight: bold;
        cursor: pointer;
        margin-top: auto;
        transition: 0.3s;
        clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
      }
      .btn-link:hover {
        background: var(--neon-blue);
        color: #000;
        box-shadow: 0 0 25px var(--neon-blue);
      }
      .btn-link.active {
        background: var(--neon-red);
        border-color: var(--neon-red);
        color: #fff;
        animation: pulseRed 1s infinite;
      }
      @keyframes pulseRed {
        0% {
          box-shadow: 0 0 10px red;
        }
        50% {
          box-shadow: 0 0 30px red;
        }
        100% {
          box-shadow: 0 0 10px red;
        }
      }
    </style>
  </head>
  <body>
    <div class="scanlines"></div>
    <div id="globe-viz"></div>

    <div id="defcon-bar"><div id="defcon-level">DEFCON 5</div></div>

    <div id="terminal">
      <div
        style="
          background: var(--neon-green);
          padding: 5px;
          font-size: 0.9rem;
          color: #000;
          font-weight: bold;
        "
      >
        root@upt-commander:~#
      </div>
      <div id="term-output">
        <div class="term-line sys">System initialized...</div>
        <div class="term-line sys">Engine: Three.js r124</div>
        <div class="term-line">Satellites: Tracking (150)</div>
        <div class="term-line cmd">Waiting for USGS Real-time Feed...</div>
      </div>
      <div id="term-input-line">
        <button id="mic-btn" onclick="toggleVoice()" title="Voice Command">
          üé§
        </button>
        <span>></span
        ><input
          type="text"
          id="term-input"
          autocomplete="off"
          placeholder="_"
        />
      </div>
    </div>

    <div id="inspector">
      <h2
        style="
          font-family: var(--tech-font);
          color: var(--neon-blue);
          margin: 0 0 5px 0;
          font-size: 1rem;
        "
      >
        TARGET ANALYSIS
      </h2>
      <div
        style="
          width: 100%;
          height: 1px;
          background: var(--neon-blue);
          margin-bottom: 15px;
          opacity: 0.5;
        "
      ></div>
      <div id="inspector-content">Selecting...</div>
      <button
        onclick="window.closeInspector()"
        style="
          width: 100%;
          margin-top: 20px;
          background: transparent;
          border: 1px solid #555;
          color: #888;
          padding: 8px;
          cursor: pointer;
          font-family: var(--tech-font);
          font-size: 0.8rem;
        "
      >
        // DISMISS
      </button>
    </div>

    <div class="hud-overlay">
      <div class="panel">
        <h3>Global Threat</h3>
        <div
          style="
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
          "
        >
          <div id="val-prob" class="big-stat">--</div>
          <div class="sub-stat">ACTIVE EVENTS (24H)</div>
        </div>
      </div>
      <div class="panel">
        <h3>Seismic Energy</h3>
        <div style="flex: 1; width: 100%; min-height: 0">
          <canvas id="waveChart"></canvas>
        </div>
        <div
          style="
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            color: #666;
          "
        >
          <span
            >MAX MAG: <span id="val-res" style="color: #fff">0.0</span></span
          >
          <span>PING: <span id="val-ping" style="color: #fff">--ms</span></span>
        </div>
      </div>
      <div class="panel">
        <h3>Event Types</h3>
        <div style="flex: 1; width: 100%; min-height: 0">
          <canvas id="radarChart"></canvas>
        </div>
      </div>
      <div class="panel" style="border-color: rgba(255, 0, 60, 0.3)">
        <h3 style="color: var(--neon-red)">Main Control</h3>
        <div
          style="
            font-family: var(--code-font);
            color: #888;
            flex: 1;
            font-size: 0.85rem;
            padding: 5px;
            overflow: hidden;
          "
        >
          > SOURCE: <span style="color: var(--neon-gold)">USGS.GOV (LIVE)</span
          ><br />
          > STATUS: <span id="status-auto">READY</span><br />
          > SAT_LINK: <span id="status-sat">ACTIVE</span>
        </div>
        <button id="btn-link" class="btn-link">CONNECT TO SATELLITE</button>
      </div>
    </div>

    <script>
      // --- ERROR SUPPRESSION ---
      const originalError = console.error;
      console.error = function (...args) {
        if (
          args[0] &&
          (args[0].toString().includes("t.map") ||
            args[0].toString().includes("pathOpacity"))
        )
          return;
        originalError.apply(console, args);
      };

      // --- A. AUDIO SYNTH ---
      class AudioSynth {
        constructor() {
          this.ctx = new (window.AudioContext || window.webkitAudioContext)();
          this.muted = false;
        }
        playTone(freq, type, duration, vol = 0.1) {
          if (this.muted) return;
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = type;
          osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
          gain.gain.setValueAtTime(vol, this.ctx.currentTime);
          gain.gain.exponentialRampToValueAtTime(
            0.01,
            this.ctx.currentTime + duration
          );
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + duration);
        }
        playBeep() {
          this.playTone(800, "sine", 0.1, 0.05);
        }
        playScan() {
          this.playTone(1200, "square", 0.05, 0.02);
        }
        playAlarm() {
          if (this.muted) return;
          const osc = this.ctx.createOscillator();
          const gain = this.ctx.createGain();
          osc.type = "sawtooth";
          osc.frequency.setValueAtTime(400, this.ctx.currentTime);
          osc.frequency.linearRampToValueAtTime(
            600,
            this.ctx.currentTime + 0.3
          );
          gain.gain.value = 0.1;
          osc.connect(gain);
          gain.connect(this.ctx.destination);
          osc.start();
          osc.stop(this.ctx.currentTime + 0.5);
        }
      }
      const sfx = new AudioSynth();

      // --- B. TERMINAL & VOICE ---
      const termOut = document.getElementById("term-output");
      const termIn = document.getElementById("term-input");
      const micBtn = document.getElementById("mic-btn");
      let recognition;

      function printTerm(msg, type = "") {
        const div = document.createElement("div");
        div.className = `term-line ${type}`;
        div.innerText = `> ${msg}`;
        termOut.appendChild(div);
        termOut.scrollTop = termOut.scrollHeight;
      }

      if ("webkitSpeechRecognition" in window) {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = false;
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.onstart = function () {
          micBtn.classList.add("listening");
          printTerm("Listening...", "voice");
        };
        recognition.onend = function () {
          micBtn.classList.remove("listening");
        };
        recognition.onresult = function (event) {
          const transcript = event.results[0][0].transcript.toLowerCase();
          printTerm(`"${transcript}"`, "voice");
          processCommand(transcript);
        };
      } else {
        micBtn.style.display = "none";
        printTerm("Voice API not supported.", "err");
      }

      function toggleVoice() {
        if (recognition) recognition.start();
      }

      termIn.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          const cmd = termIn.value.trim().toLowerCase();
          printTerm(cmd, "cmd");
          processCommand(cmd);
          termIn.value = "";
          sfx.playBeep();
        }
      });

      function processCommand(cmd) {
        const parts = cmd.split(" ");
        if (cmd.includes("scan") || cmd.includes("qu√©t")) {
          printTerm("Manual scan initiated...", "sys");
          fetchData();
        } else if (cmd.includes("status") || cmd.includes("b√°o c√°o")) {
          printTerm(`DEFCON: ${currentDefcon}`, "sys");
          printTerm(`NODES: ${currentNodeCount}`, "sys");
        } else if (cmd.includes("mute") || cmd.includes("im l·∫∑ng")) {
          sfx.muted = true;
          printTerm("Audio Muted.", "sys");
        } else if (cmd.includes("unmute") || cmd.includes("b·∫≠t ti·∫øng")) {
          sfx.muted = false;
          printTerm("Audio Enabled.", "sys");
        } else if (cmd.includes("vietnam") || cmd.includes("vi·ªát nam")) {
          world.pointOfView({ lat: 14.0, lng: 108.0, altitude: 0.8 }, 2000);
          printTerm("Moving to VIETNAM...");
        } else if (cmd.includes("japan") || cmd.includes("nh·∫≠t b·∫£n")) {
          world.pointOfView({ lat: 36.0, lng: 138.0, altitude: 0.8 }, 2000);
          printTerm("Moving to JAPAN...");
        } else if (cmd.includes("usa") || cmd.includes("m·ªπ")) {
          world.pointOfView({ lat: 37.0, lng: -95.0, altitude: 1.0 }, 2000);
          printTerm("Moving to USA...");
        } else if (cmd === "sats" || cmd.includes("v·ªá tinh")) {
          showSats = !showSats;
          world.customLayerData(showSats ? satData : []);
          printTerm(`Satellites: ${showSats ? "ON" : "OFF"}`, "sys");
        } else if (cmd === "help")
          printTerm("TRY: scan, status, mute, vietnam, usa, sats");
        else printTerm("Command not recognized.", "err");
      }

      // --- C. MAIN LOGIC & SATELLITES ---
      let isLive = false;
      let timer = null;
      let world;
      let previousDataHash = "";
      let currentDefcon = 5;
      let currentNodeCount = 0;
      let showSats = true;

      const satData = [...Array(150).keys()].map(() => ({
        lat: (Math.random() - 0.5) * 180,
        lng: (Math.random() - 0.5) * 360,
        alt: 0.6 + Math.random() * 0.3,
        velocity: Math.random() * 0.4 + 0.1,
        color: "#ffd700",
      }));

      function updateDefcon(maxMag) {
        const el = document.getElementById("defcon-level");
        const bar = document.getElementById("defcon-bar");
        const body = document.body;
        let level = 5;
        let color = "var(--defcon-5)";

        // Logic Defcon d·ª±a tr√™n ƒë·ªô l·ªõn ƒë·ªông ƒë·∫•t
        if (maxMag > 5.0) {
          level = 4;
          color = "var(--defcon-4)";
        }
        if (maxMag > 6.0) {
          level = 3;
          color = "var(--defcon-3)";
        }
        if (maxMag > 7.0) {
          level = 2;
          color = "var(--defcon-2)";
        }
        if (maxMag > 8.0) {
          level = 1;
          color = "var(--defcon-1)";
        }

        if (level !== currentDefcon) {
          currentDefcon = level;
          el.innerText = `DEFCON ${level}`;
          el.style.color = color;
          bar.style.borderColor = color;
          bar.style.boxShadow = `0 0 30px ${color}`;
          if (level <= 2) {
            body.classList.add("alert-mode");
            sfx.playAlarm();
            printTerm("!!! HIGH ALERT !!!", "err");
          } else body.classList.remove("alert-mode");
        }
      }

      // --- D. INIT GLOBE ---
      try {
        world = Globe()(document.getElementById("globe-viz"))
          .globeImageUrl("//unpkg.com/three-globe/example/img/earth-dark.jpg")
          .bumpImageUrl(
            "//unpkg.com/three-globe/example/img/earth-topology.png"
          )
          .backgroundImageUrl(
            "//unpkg.com/three-globe/example/img/night-sky.png"
          )
          .atmosphereColor("#00f3ff")
          .atmosphereAltitude(0.2)
          .showGraticules(true)
          .pointAltitude("alt")
          .pointColor("color")
          .pointRadius(0.5)
          .pointsMerge(false)
          .ringColor("color")
          .ringMaxRadius("maxR")
          .ringPropagationSpeed(5)
          .ringRepeatPeriod(800)

          // SATELLITES
          .customLayerData(satData)
          .customThreeObject((d) => {
            const geometry = new THREE.TetrahedronGeometry(1.2);
            const material = new THREE.MeshLambertMaterial({ color: d.color });
            return new THREE.Mesh(geometry, material);
          })
          .customThreeObjectUpdate((obj, d) => {
            Object.assign(obj.position, world.getCoords(d.lat, d.lng, d.alt));
            obj.rotation.y += 0.1;
            d.lng += d.velocity;
            if (d.lng > 180) d.lng = -180;
          })

          .onPointClick((d) => {
            sfx.playBeep();
            world.pointOfView({ lat: d.lat, lng: d.lng, altitude: 1.2 }, 1500);
            showInspector(d);
          });

        world.controls().autoRotate = true;
        world.controls().autoRotateSpeed = 0.5;
      } catch (e) {
        console.error(e);
      }

      // --- E. CHARTS ---
      Chart.defaults.color = "#666";
      Chart.defaults.font.family = "Rajdhani";
      const waveChart = new Chart(document.getElementById("waveChart"), {
        type: "line",
        data: {
          labels: Array(30).fill(""),
          datasets: [
            {
              data: Array(30).fill(0),
              borderColor: "#00f3ff",
              borderWidth: 2,
              pointRadius: 0,
              tension: 0.5,
              fill: true,
              backgroundColor: "rgba(0,243,255,0.1)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { display: false },
            y: { display: false, min: 0, max: 10 },
          },
          animation: { duration: 0 },
        },
      });
      const radarChart = new Chart(document.getElementById("radarChart"), {
        type: "polarArea",
        data: {
          labels: ["Minor", "Moderate", "Strong", "Major", "Great"],
          datasets: [
            {
              data: [0, 0, 0, 0, 0],
              backgroundColor: [
                "#00f3ff",
                "#00ff66",
                "#ffd700",
                "#ff6600",
                "#ff003c",
              ],
              borderWidth: 1,
              borderColor: "#111",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: "right",
              labels: { color: "#ccc", boxWidth: 10, font: { size: 9 } },
            },
          },
          scales: { r: { grid: { color: "#333" }, ticks: { display: false } } },
        },
      });

      // --- F. REAL DATA FETCH (USGS API) ---
      async function fetchData() {
        const start = Date.now();
        try {
          // L·∫•y d·ªØ li·ªáu ƒë·ªông ƒë·∫•t 2.5+ trong ng√†y
          const res = await fetch(
            "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson"
          );
          const data = await res.json();

          document.getElementById("val-ping").innerText =
            Date.now() - start + "ms";

          if (data.features) updateUI(data.features);
        } catch (e) {
          console.error(e);
          printTerm("Connection failed. Check Internet.", "err");
        }
      }

      function updateUI(features) {
        // Stats
        document.getElementById("val-prob").innerText = features.length;

        // T√¨m tr·∫≠n ƒë·ªông ƒë·∫•t l·ªõn nh·∫•t ƒë·ªÉ c·∫≠p nh·∫≠t Defcon
        let maxMag = 0;
        let counts = [0, 0, 0, 0, 0]; // Minor, Mod, Strong, Major, Great

        const globeData = features.map((f) => {
          const mag = f.properties.mag;
          if (mag > maxMag) maxMag = mag;

          // Ph√¢n lo·∫°i
          let type = "QUAKE (MINOR)";
          let color = "#00f3ff";
          if (mag < 4.0) {
            counts[0]++;
          } else if (mag < 5.0) {
            counts[1]++;
            type = "QUAKE (MODERATE)";
            color = "#00ff66";
          } else if (mag < 6.0) {
            counts[2]++;
            type = "QUAKE (STRONG)";
            color = "#ffd700";
          } else if (mag < 7.0) {
            counts[3]++;
            type = "QUAKE (MAJOR)";
            color = "#ff6600";
          } else {
            counts[4]++;
            type = "QUAKE (GREAT)";
            color = "#ff003c";
          }

          return {
            lat: f.geometry.coordinates[1],
            lng: f.geometry.coordinates[0],
            alt: mag * 0.05, // Chi·ªÅu cao c·ªôt theo ƒë·ªô l·ªõn
            color: color,
            type: type,
            place: f.properties.place,
            energy_level: mag, // D√πng ƒë·ªô l·ªõn l√†m nƒÉng l∆∞·ª£ng
            time: new Date(f.properties.time).toLocaleTimeString(),
            maxR: mag > 5.0 ? mag * 5 : 0, // Ch·ªâ t·∫°o s√≥ng n·∫øu > 5.0
          };
        });

        // Update UI Elements
        document.getElementById("val-res").innerText = maxMag.toFixed(1);
        updateDefcon(maxMag);
        sfx.playScan();

        // Charts
        waveChart.data.datasets[0].data.push(maxMag);
        waveChart.data.datasets[0].data.shift();
        waveChart.update();

        radarChart.data.datasets[0].data = counts;
        radarChart.update();

        // Update Globe
        if (world) {
          world.pointsData(globeData);
          world.ringsData(globeData.filter((d) => d.maxR > 0));
        }

        // Check Update
        if (features.length !== currentNodeCount) {
          currentNodeCount = features.length;
          printTerm(`Synced ${currentNodeCount} real-time events.`);
        }
      }

      // --- G. CONTROLS ---
      window.showInspector = (d) => {
        document.getElementById("inspector").classList.add("active");
        let icon = "üìâ";
        const statusColor = d.color;

        document.getElementById("inspector-content").innerHTML = `
                <div class="insp-row"><span class="insp-lbl">CLASS</span> <strong style="color:${
                  d.color
                }">${icon} ${d.type}</strong></div>
                <div class="insp-row"><span class="insp-lbl">LOC</span> <span class="insp-val" style="font-size:0.8rem; max-width:180px;">${
                  d.place
                }</span></div>
                <div class="insp-row"><span class="insp-lbl">TIME</span> <span class="insp-val">${
                  d.time
                }</span></div>
                <div class="insp-row"><span class="insp-lbl">MAGNITUDE</span> <span class="insp-val" style="font-size:1.5rem; color:${
                  d.color
                }">${d.energy_level.toFixed(1)}</span></div>
                <div class="status-box" style="border: 1px solid ${statusColor}; color:${statusColor}">CONFIRMED REAL DATA</div>
            `;
        printTerm(`Report: ${d.type} - Mag ${d.energy_level}`);
      };
      window.closeInspector = () => {
        document.getElementById("inspector").classList.remove("active");
        if (world) world.pointOfView({ altitude: 2.5 }, 1500);
      };

      document.getElementById("btn-link").addEventListener("click", () => {
        isLive = !isLive;
        const btn = document.getElementById("btn-link");
        // --- C·∫¨P NH·∫¨T TR·∫†NG TH√ÅI HUD ---
        const statusAuto = document.getElementById("status-auto");
        const statusSat = document.getElementById("status-sat");

        if (isLive) {
          sfx.ctx.resume();
          btn.classList.add("active");
          btn.innerText = "ABORT UPLINK";
          if (world) world.controls().autoRotate = false;
          printTerm("Connecting to USGS Satellite...");
          sfx.playBeep();
          fetchData();
          timer = setInterval(fetchData, 60000); // Qu√©t m·ªói 60s (USGS kh√¥ng c·∫ßn 3s)

          statusAuto.innerText = "ENGAGED";
          statusAuto.style.color = "var(--neon-green)";
          statusSat.innerText = "LOCKED";
          statusSat.style.color = "var(--neon-green)";
        } else {
          btn.classList.remove("active");
          btn.innerText = "CONNECT TO SATELLITE";
          clearInterval(timer);
          if (world) world.controls().autoRotate = true;
          printTerm("Uplink Terminated.");

          statusAuto.innerText = "STANDBY";
          statusAuto.style.color = "#888";
          statusSat.innerText = "IDLE";
          statusSat.style.color = "#888";
        }
      });
    </script>
  </body>
</html>
